---
title: Fast approximate Bayesian inference for small-area estimation of HIV indicators using the Naomi model
author:
  - name: Adam 
    surname: Howes
    email: ath19@ic.ac.uk
    label: e1
    addressLabel: A,D
    sepNext: ","
  - name: Alex
    surname: Stringer
    email: alex.stringer@uwaterloo.ca
    label: e2
    addressLabel: B
  - name: Seth R.
    surname: Flaxman
    email: seth.flaxman@cs.ox.ac.uk
    label: e3
    addressLabel: C
    sepNext: ","
  - name: Jeffrey W.
    surname: Eaton
    email: jeffrey.eaton@imperial.ac.uk
    label: e4
    addressLabel: D
affiliation:
  - label: A
    name: Department of Mathematics, Imperial College London
    authorsLabels: e1
  - label: B
    name: Department of Statistics and Actuarial Science, University of Waterloo
    authorsLabels: e2
  - label: C
    name: Department of Computer Science, University of Oxford
    authorsLabels: e3
  - label: D
    name: MRC Centre for Global Infectious Disease Analysis, School of Public Health, Imperial College London
    authorsLabels: e4
abstract: |
  | Naomi is a spatial evidence synthesis model used to produce district-level HIV epidemic indicators in sub-Saharan Africa. Multiple outcomes of policy interest, including HIV prevalence, HIV incidence, and antiretroviral therapy treatment coverage are jointly modelled using both household survey data and routinely reported health system data. The model is provided as a tool for countries to input their data to and generate estimates using an empirical Bayes Gaussian approximation via the \texttt{TMB} \textsc{R} package. We propose a new inference method extending adaptive Gauss-Hermite quadrature to deal with >20 hyperparameters, thereby enabling fast and accurate inference for Naomi and other extended latent Gaussian models. Using data from Malawi, our method provides more accurate inferences than \texttt{TMB}, and is substantially faster to run to Hamiltonian Monte Carlo with the No-U-Turn sampler. By extending the \texttt{aghq} \textsc{R} package we facilitate easy, flexible use of our method when provided a \texttt{TMB} \textsf{C++} template for the model's log-posterior.
keyword-subclass: | 
 \begin{keyword}[class=MSC2020] % It must be define for aap, aop, aos journals. For aoas, sts is not used
 \kwd[Primary ]{00X00}
 \kwd{00X00}
 \kwd[; secondary ]{00X00}
 \end{keyword}
keywords: 
  - spatial statistics
  - small-area estimation
  - INLA
  - AGHQ
  - HIV epidemiology

predefined-theoremstyle: true # use in section Environments for Axiom, Theorem, etc
bibliography: citations.bib
biblio-style: imsart-nameyear # alternative: imsart-number
output:
  rticles::ims_article:
    journal: aoas # aap, aoas, aop, aos, sts. See documentation
    toc: false # Please use for articles with 50 pages and more
    includes:
      in_header: preamble.tex
---

<!-- Remaining things to add, and or desiderata: -->

<!-- * [ ] Tying together Naomi model within LGM / ELGM mathematical notation -->
<!-- * [ ] Create DAG representing Naomi model. This would likely go into the appenxix, so use that notation -->
<!-- * [ ] Rewrite section on why Naomi is an ELGM, drawing from slides -->
<!-- * [ ] Write section on Laplace approximation -->
<!-- * [ ] Write section on AGHQ, tying together connection to Laplace for k = 1 -->
<!-- * [ ] Move algorithm to algorithm environment -->

<!-- Seth notes that Naomi is a spatial evidence synthesis model used to produce district- level HIV epidemic indicators in sub-Saharan Africa is not the right topic sentence for the abstract -->
<!-- Better to lead with something about the inference method? -->

```{r echo = FALSE}
options(scipen = 100)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dpi = 320,
  cache = TRUE,
  out.width = "95%",
  fig.align = 'center'
)
```

<!-- Most published papers will not exceed 20 pages -->
<!-- We strongly encourage submission of data sets, computer algorithms and supporting material -->

# Introduction

To mount an effective public health response to the HIV epidemic, it is crucial to have accurate, timely estimates of HIV indicators at the geographic level at which health systems are planned and delivered.
However, producing these estimates is challenging, in large part due to limitations of the available data sources.
Nationally-representative household surveys provide the most statistically reliable data, but due to their high cost, in most countries they are conducted only every five years or so, with limited sample size at the district level.
Other data sources, such as routine health surveillance of antenatal care (ANC) clinics, are available in more real-time but based on limited or non-representative samples of the population.
To address these challenges, the Naomi small-area estimation model [@eaton2021naomi] synthesises data from multiple sources to estimate HIV indicators at a district-level.
Modelling multiple data sources jointly has many benefits, including mitigating the limitations of any single source, increasing statistical power, and prompting investigation into any conflicts of information between sources.
Software (\url{https://naomi.unaids.org}) has been developed for Naomi, allowing countries to input their data and interactively generate estimates in a yearly process supported by UNAIDS.
Creation of estimates by country teams, rather than external agencies, is a noteworthy feature of the HIV response.
Drawing on expertise closest to the data being modelled improves the accuracy of the process, as well as strengthening trust and ownership of the resulting estimates.

The complexity of the model, in combination with practical requirements for its operation, present a difficult Bayesian inference problem.
First, due to dependence of observations on multiple structured additive predictors, Naomi falls into the class of extended latent Gaussian models (ELGMs) [@stringer2022fast].
Furthermore, as well as hundreds of latent field parameters, Naomi has >20 hyperparameters: substantially more than the small number typically required for use of integrated nested Laplace approximations [@rue2009approximate].
Any inferential strategy must be fast enough for interactive review and iteration of modelling results, as well as easy to run in production across a range of countries.
In this setting, Markov chain Monte Carlo (MCMC) approaches are prohibitively slow, both due to the scale of the model and challenging features of its posterior geometry [@neal2003slice].
Inference is currently conducted using an empirical Bayes (EB) approach, with a Gaussian approximation to the latent field, via the Template Model Builder (`TMB`) \textsf{R} package [@kristensen2016tmb].
Owing to its speed and flexibility, `TMB` has recently been gaining popularity more broadly in spatial statistics [@osgood2022statistical].
Inference in `TMB` is based on optimisation of a \textsf{C++} template function, with the option available to use a Laplace approximation to integrate out any subset of the function arguments.
In the Naomi model, this subset is the high-dimensional latent field.
Taking inspiration from the AD Model Builder (ADMB) package [@fournier2012ad], `TMB` uses automatic differentiation [@baydin2017automatic] to calculate the derivatives required for numerical optimisation routines and the Laplace approximation.
Although this approach is fast, it has the downside that within the empirical Bayes framework hyperparameter uncertainty is not accounted for in the latent field posterior.
This has motivated us to look for an approach closer to full Bayesian inference, which is also flexible enough to be compatible with the model, as well as fast enough to be run in production by country teams.

To obtain fast, accurate Bayesian inferences for the Naomi model we develop an inference methodology which extends adaptive Gauss-Hermite quadrature (AGHQ) to handle a higher number of hyperparameters. 
We implement our method as an extension of the `aghq` \textsf{R} package [@stringer2021implementing].
Since `aghq` is designed to naturally interface with `TMB`, use of our method is simple when provided a \textsf{C++} user template for the log-posterior.

The remainder of this paper is organised as follows.
Section \ref{sec:naomi} outlines the version of the Naomi model that we consider in this paper, and  Section \ref{sec:elgm} describes how it falls within the ELGM framework.
Section \ref{sec:fastinferencemethods} outlines our approach to fast, accurate Bayesian inference for ELGMs using simplified INLA and AGHQ.
As a case-study, we compare the accuracy of our inference method to `TMB` and `tmbstan` for the simplified Naomi model fit to data from Malawi, in Section \ref{sec:naomi}.
We also demonstrate a Bayesian workflow, illustrating the applicability of these tools in a deterministic inference setting.
Finally, in Section \ref{sec:conclusions} we discuss our conclusions, how we anticipate our method might be useful for other models, and directions for future research.

# A simplified Naomi model\label{sec:naomi}

@eaton2021naomi specify a joint model linking three small-area estimation models, defined over three time points $T_i, i = 1, 2, 3$.
We consider a simplified version defined only at the time of the most recent household survey with HIV testing ($T_1$), omitting nowcasting ($T_2$) and temporal projection ($T_3$) which involve limited additional inference.
An overview of this simplified model is given below.
A more complete mathematical description (Appendix S1) as well as a \textsf{C++} template for the log-posterior (Appendix S3) are provided in the supplementary material.

## Household survey component \label{sec:household}

Consider a country in sub-Saharan Africa where a household survey with complex design has taken place at time $T_1$.
Let $x \in \mathcal{X}$ index district, $a \in \mathcal{A}$ index five-year age group, and $s \in \mathcal{S}$ index sex.
For ease of notation, let $i$ index the finest district-age-sex division included in the model.
Let $\mathcal{I} \subseteq \mathcal{X} \times \mathcal{A} \times \mathcal{S}$ be a set of indices $i$ for which an aggregate observation is reported.

Let $N_i \in \mathbb{N}$ be the known, fixed population size.
We infer the following unknown HIV indicators using coupled regression equations: HIV prevalence $\rho_i \in [0, 1]$, the proportion of individuals who are HIV positive; antiretroviral therapy (ART) coverage $\alpha_i \in [0, 1]$, the proportion of people living with HIV who receive ART treatment; and annual HIV incidence rate $\lambda_i > 0$, the yearly rate of new HIV infections occurring.
Independent logistic regression models for HIV prevalence and ART coverage in the general population are specified such that $\text{logit}(\rho_i) = \eta^\rho_i$ and $\text{logit}(\alpha_i) = \eta^\alpha_i$, for certain choice of structured additive predictors.
HIV incidence rate is modelled on the log scale as $\log(\lambda_i) = \eta^\lambda_i$, and depends on adult HIV prevalence and adult ART coverage. 
Let $\kappa_i$ be the proportion recently infected among HIV positive persons, which we link to HIV incidence via
\begin{equation}
\kappa_i = 1- \exp \left( - \lambda_i \cdot \frac{1 - \rho_i}{\rho_i} \cdot (\Omega_T - \beta_T) - \beta_T \right), \label{eq:kappa}
\end{equation}
where the mean duration of recent infection $\Omega_T$ and the proportion of long-term HIV infections misclassified as recent $\beta_T$ are strongly informed by priors for the particular survey.

These processes are informed by household survey data.
For $\theta \in \{\rho, \alpha, \kappa\}$ let
$$
\hat \theta_\mathcal{I} = \frac{\sum_j w_j \cdot\theta_j}{\sum_j w_j}
$$
be weighted, aggregate survey observations, where $j$ indexes individuals across all strata $i \in \mathcal{I}$ and $w_j$ are design weights.
The observed number of outcomes are $y^{\hat \theta}_{\mathcal{I}} = m^{\hat \theta}_{\mathcal{I}} \cdot \hat \theta_{\mathcal{I}}$ where
$$
m^{\hat \theta}_\mathcal{I} = \frac{\left(\sum_j w_j\right)^2}{\sum_j w_j^2},
$$
is the Kish effective sample size [@kish1965survey].
We use a binomial working likelihood
$$
y^{\hat \theta}_{\mathcal{I}} \sim \text{xBin}(m^{\hat \theta}_{\mathcal{I}}, \theta_{\mathcal{I}})
$$
to model these aggregate observations, where $\theta_{\mathcal{I}}$ are the following weighted aggregates
\begin{equation*}
\rho_{\mathcal{I}} = \frac{\sum_{i \in \mathcal{I}} N_i \rho_i}{\sum_{i \in \mathcal{I}} N_i}, \quad
\alpha_{\mathcal{I}} = \frac{\sum_{i \in \mathcal{I}} N_i \rho_i \alpha_i}{\sum_{i \in \mathcal{I}} N_i \rho_i}, \quad
\kappa_{\mathcal{I}} = \frac{\sum_{i \in \mathcal{I}} N_i \rho_i \kappa_i}{\sum_{i \in \mathcal{I}} N_i \rho_i}.
\end{equation*}

## ANC testing component \label{sec:anc}

HIV prevalence $\rho^\text{ANC}_i$ and ART coverage $\alpha^\text{ANC}_i$ among pregnant women are modelled as offset from the general population indicators as follows
\begin{align*}
\text{logit}(\rho^\text{ANC}_i) &= \text{logit}(\rho_i) + \eta^{\rho^\text{ANC}}_i, \\
\text{logit}(\alpha^\text{ANC}_i) &= \text{logit}(\alpha_i) + \eta^{\alpha^\text{ANC}}_i.
\end{align*}
These processes are informed by likelihoods specified for aggregate ANC data from the year of the most recent survey.
In particular, the number of ANC clients with ascertained status $x^\text{ANC}_\mathcal{I}$, the number of those with positive status $y^\text{ANC}_\mathcal{I}$, and the number of ANC clients already on ART prior to their first ANC visit $z^\text{ANC}_\mathcal{I}$.
We use the binomial working likelihoods
\begin{align*}
y^\text{ANC}_\mathcal{I} &\sim \text{Bin}(x^\text{ANC}_\mathcal{I}, \rho^\text{ANC}_{\mathcal{I}}), \\
z^\text{ANC}_\mathcal{I} &\sim \text{Bin}(y^\text{ANC}_\mathcal{I}, \alpha^\text{ANC}_{\mathcal{I}}),
\end{align*}
where, again, we use weighted aggregates
\begin{equation*}
\rho^\text{ANC}_{\mathcal{I}} = \frac{\sum_{i \in \mathcal{I}} \Psi_i \rho_i^\text{ANC}}{\sum_{i \in \mathcal{I}} \Psi_i}, \quad
\alpha^\text{ANC}_{\mathcal{I}} = \frac{\sum_{i \in \mathcal{I}} \Psi_i \rho_i^\text{ANC} \alpha^\text{ANC}_i}{\sum_{i \in \mathcal{I}} \Psi_i \rho_i^\text{ANC}},
\end{equation*}
with $\Psi_i$ the number of pregnant women, which we assume to be fixed.

## ART attendance component \label{sec:art}

People living with HIV sometimes choose to access ART services outside of the district that they reside in.
To account for this, we use multinomial logistic regression to model the probabilities of accessing services outside the home district.
Let $\gamma_{x, x'}$ be the probability that a person on ART residing in district $x$ receives ART in district $x'$, and assume $\gamma_{x, x'} = 0$ unless $x = x'$ or the two districts are neighbouring, denoted by $x \sim x'$.
The log-odds $\tilde \gamma_{x, x'} = \text{logit}(\gamma_{x, x'})$ are modelled using a structured additive predictor $\eta_x^{\tilde \gamma}$ which only depends on the home district $x$, such that travel to each neighbouring district, for all age-sex strata, is equally likely.
Aggregate ART attendance data $\dot A_\mathcal{I}$ is modelled using a Gaussian approximation to a sum of binomials.
The sum results both by aggregation over $i \in \mathcal{I}$ and by number of ART clients travelling from district $x'$ to $x$.
More details regarding this part of the model are provided in Appendix S1.

# Extended Latent Gaussian models\label{sec:elgm}

We now describe a popular class of models, and an extension encapsulates the complexities of Naomi.

## Definitions

Latent Gaussian models (LGMs) [@rue2009approximate] are three-stage hierarchical models of the form
\begin{align*}
y_i &\sim p(y_i \, | \, \eta_i, \btheta_1), \quad i \in [n]\\
\mu_i &= \mathbb{E}(y_i \, | \, \eta_i) = g(\eta_i), \\
\eta_i &= \beta_0 + \sum_{l = 1}^{p} \beta_j z_{ji} + \sum_{k = 1}^{r} f_k(u_{ki}),
\end{align*}
where $[n] = \{1, \ldots, n\}$.
The response variable is $\y = (y)_{i \in [n]}$ with likelihood $p(\y \, | \, \bmeta, \btheta_1) = \prod_{i = 1}^n p(y_i \, | \, \eta_i, \btheta_1)$, where $\bmeta = (\eta)_{i \in [n]}$.
Each response has conditional mean $\mu_i$ with inverse link function $g: \mathbb{R} \to \mathbb{R}$ such that $\mu_i = g(\eta_i)$.
The vector $\btheta_1 \in \mathbb{R}^s$, with $s_1$ assumed small, are additional parameters of the likelihood.
The structured additive predictor $\eta_i$ may include an intercept $\beta_0$, linear effects $\beta_j$ of the covariates $z_{ji}$, and unknown functions $f_k(\cdot)$ of the covariates $u_{ki}$.
The parameters $\beta_0$, $\{\beta_j\}$, $\{f_k(\cdot)\}$ are each assigned Gaussian priors.
It is convenient to collect these parameters into a vector $\x \in \mathbb{R}^N$ called the latent field such that $\x \sim \mathcal{N}(0, \bm{Q}(\btheta_2)^{-1})$ where $\btheta_2 \in \mathbb{R}^{s_2}$ are further parameters, again with $s_2$ assumed small.
Let $\btheta = (\btheta_1, \btheta_2) \in \mathbb{R}^s$ with $m = s_1 + s_2$ be all hyperparameters, with prior $p(\btheta)$.

Extended latent Gaussian models (ELGMs) [@stringer2022fast] relax the restriction that there is a one-to-one mapping between the mean response $\bmu$ and structured additive predictor $\bmeta$.
Instead, the structured additive predictor is redefined as $\bmeta = (\eta)_{i \in [N_n]}$, where $N_n \in \mathbb{N}$ is a function of $n$, and it is possible that $N_n \neq n$.
Each mean response $\mu_i$ now depends on some subset $\mathcal{J}_i \subseteq [N_n]$ of indices of $\bmeta$, with $\cup_{i = 1}^n \mathcal{J}_i = [N_n]$ and $1 \leq |\mathcal{J}_i| \leq N_n$.
The inverse link function $g(\cdot)$ is redefined for each observation to be a possibly many-to-one mapping $g_i: \mathbb{R}^{|\mathcal{J}_i|} \to \mathbb{R}$, such that $\mu_i = g_i(\bmeta_{\mathcal{J}_i})$.
Importantly, this mapping allows for the presence of non-linearity in the model.
Put together, ELGMs are then of the form
\begin{align*}
y_i &\sim p(y_i \, | \, \bmeta_{\mathcal{J}_i}, \btheta_1), \quad i \in [n] \\
\mu_i &= \mathbb{E}(y_i \, | \, \bmeta_{\mathcal{J}_i}) = g_i(\bmeta_{\mathcal{J}_i}), \\
\eta_j &= \beta_0 + \sum_{l = 1}^{p} \beta_j z_{ji} + \sum_{k = 1}^{r} f_k(u_{ki}), \quad j \in [N_n].
\end{align*}

## Naomi as an ELGM

Naomi has a lot in common with many LGMS: it is a spatio-temporal model with a large latent field, governed by a smaller number of hyperparameters.
However, Naomi is not an LGM, and instead falls into the ELGM class, for the following reasons:

1. In the household survey component, HIV incidence depends on district-level adult HIV prevalence and ART coverage, such that $\lambda \propto \rho (1 - \omega \cdot \alpha)$, where $\omega = 0.7$ is a fixed constant. This reflects basic HIV epidemiology: HIV incidence is proportional to unsuppresed viral load. As a result, $\log(\lambda_i)$ depends on 28 structured additive predictors (2 sexes $\times$ 7 age groups $\times$ 2 indicators, HIV prevalence and ART coverage).
2. In the household survey component, HIV incidence and HIV prevalence are linked to the proportion recently infected via Equation \ref{eq:kappa}.
3. In the ANC testing component, HIV prevalence and ART coverage depend upon the respective indicators in the household survey component. Although $\text{logit}(\rho_i)$ and $\text{logit}(\alpha_i)$ are Gaussian, nonetheless this introduces dependence of each mean response on two structured additive predictors.
4. Throughout the model components, processes are modelled at the finest distict-age-sex division, but likelihoods are defined for observations aggregated over sets of indices. As such, single observations are related to $|\mathcal{I}|$ structured additive predictors.
5. Individuals taking ART, or who have been recently infected, must be HIV positive. 
6. The ART attendance component uses a multinomial model with softmax link function which takes as input $|\{x': x' \sim x\}| + 1$ structured additive predictors.
7. Multiple link functions are used throughout the model, such that there is no one inverse link function $g$. Instead, 

# Fast approximate inference method\label{sec:fastinferencemethods}

The joint posterior of $(\x, \btheta)$ for an ELGM is given by
\begin{equation*}
  p(\x, \btheta \, | \, \y)
  \propto p(\btheta) |\mathbf{Q}(\btheta)|^{n/2} \exp \left( - \frac{1}{2} \x^\top \mathbf{Q}(\btheta) \x + \sum_{i = 1}^n \log p(y_i \, | \, \x_{\mathcal{J}_i}, \btheta) \right).
\end{equation*}
We consider approximations to the posterior marginals of each latent random variable $x_i$ and hyperparameter $\theta_j$ given by
\begin{align}
  \tilde p(x_i \, | \, \y) \approx p(x_i \, | \, \y) &= \int p(x_i, \btheta \, | \, \y) \text{d} \btheta = \int p(x_i \, | \, \btheta, \y) p(\btheta \, | \, \y) \text{d}\btheta, \quad i \in [N], \label{eq:inla1} \\
  \tilde p(\theta_j \, | \, \y) \approx p(\theta_j \, | \, \y) &= \int p(\btheta \, | \, \y) \text{d}\btheta_{-j} \quad j \in [m]. \label{eq:inla2}
\end{align}
Given the negative unnormalised log posterior $- \log p(\y, \x, \btheta)$, we obtain the above posterior marginal approximations $\{ \tilde p(x_i \, | \, \y) \}_{i = 1}^n$ and $\{\tilde p(\theta_j \, | \, \y)\}_{j = 1}^m$ via nested applications of the Laplace approximation and AGHQ.

## Laplace approximation

Let $\tilde p_\texttt{G}(\x \, | \, \btheta, \y) = \mathcal{N}(\x \, | \, \hat \x(\btheta), \mathbf{H}(\btheta)^{-1})$ be a Gaussian approximation to $p(\x \, | \, \btheta, \y)$ with mode and precision matrix given by
\begin{align*}
\hat \x(\btheta) &= \argmax_\x \log p(\y, \x, \btheta), \\
\mathbf{H}(\btheta) &= - \frac{\partial^2}{\partial x \partial x^\top} \log p(\y, \x, \btheta) \rvert_{\x = \hat \x(\btheta)}.
\end{align*}
Then the Laplace approximation to $p(\btheta, \y)$ is given by
$$
\tilde p_\texttt{LA}(\btheta, \y) = \frac{p(\y, \x, \btheta)}{\tilde p_\texttt{G}(\x \, | \, \btheta, \y)} \Big\rvert_{\x = \hat \x(\btheta)}
$$

## AGHQ

A quadrature rule can be used to approximate the integral of a function $f: \mathcal{Z} \to \mathbb{R}$ by the following weighted sum
$$
\int_{\z \in \mathcal{Z}} f(\z) \text{d}\z \approx \sum_{\z \in \mathcal{Q}} f(\z) w(\z),
$$
where $\z \in \mathcal{Q} \subset \mathcal{Z}$ are a set of nodes and $\omega: \mathcal{Q} \to \mathbb{R}$ is a weighting function.
In Gauss-Hermite quadrature [@davis1975methods] the nodes are selected as zeros of the Hermite polynomials, with weights chosen so as to interpolate functions of the form $f(\z) = \tilde f(\z) \exp(-\z^2)$.
In adaptive Gauss-Hermite quadrature [@naylor1982applications; @tierney1986accurate] the nodes and weights are shifted and rotated to suit the particular integrand, based on the mode, curvature at the mode, and a matrix decomposition of the inverse curvature.
Two possibilities for this matrix decomposition are the Cholesky decomposition and the spectral decomposition [@jackel2005note].


```{r aghq, fig.cap="The Gauss-Hermite quadrature nodes $\\z \\in \\mathcal{Q}(2, 3)$ for this two dimensional integral with three nodes per dimension (a) are adapted based on the mean (b) and covariance matrix of the target via $f(\\z) = \\hat f + \\mathbf{L} \\z$, where..."}
mu <- c(1, 1.5)
cov <- matrix(c(2, 1, 1, 1), ncol = 2)

obj <- function(theta) {
  mvtnorm::dmvnorm(theta, mean = mu, sigma = cov)
}

grid <- expand.grid(
  theta1 = seq(-2, 5, length.out = 700),
  theta2 = seq(-2, 5, length.out = 700)
)

ground_truth <- cbind(grid, pdf = obj(grid))

plot0 <- ggplot(ground_truth, aes(x = theta1, y = theta2, z = pdf)) +
  geom_contour(col = multi.utils::cbpalette()[1]) +
  coord_fixed(xlim = c(-2, 4.5), ylim = c(-2, 4.5), ratio = 1) +
  labs(x = "", y = "") +
  theme_minimal() +
  guides(size = FALSE) +
  theme(
    axis.text.x = element_blank(), axis.ticks.x = element_blank(),
    axis.text.y = element_blank(), axis.ticks.y = element_blank()
  )

gg <- mvQuad::createNIGrid(2, "GHe", 3)

add_points <- function(plot0, gg) {
  plot0 +
    geom_point(
      data = mvQuad::getNodes(gg) %>%
              as.data.frame() %>%
              mutate(weights = mvQuad::getWeights(gg)),
      aes(x = V1, y = V2, size = weights),
      alpha = 0.8,
      col = multi.utils::cbpalette()[2],
      inherit.aes = FALSE
    ) +
    scale_size_continuous(range = c(1, 2))
}

plot1 <- add_points(plot0, gg) +
  labs(size = "", subtitle = "(a)")

#' Adapt by the mean
gg2 <- gg
mvQuad::rescale(gg2, m = mu, C = diag(c(1, 1)), dec.type = 2)

plot2 <- add_points(plot0, gg2) +
  labs(size = "", subtitle = "(b)")

#' Adapt by the lower Cholesky
gg3 <- gg
mvQuad::rescale(gg3, m = mu, C = cov, dec.type = 2)

plot3 <- add_points(plot0, gg3) +
  labs(size = "", subtitle = "(c)")

#' Adapt by the spectral
gg4 <- gg
mvQuad::rescale(gg4, m = mu, C = cov, dec.type = 1)

plot4 <- add_points(plot0, gg4) +
  labs(size = "", subtitle = "(d)")

(plot1 + plot2) / (plot3 + plot4)
```

# Application to data from Malawi\label{sec:results}

We fit the simplified Naomi model (Section \ref{sec:naomi}) to data from Malawi using three inferential approaches.
For each approach, the `TMB` C++ user-template (available in the appendix) used to specify the log-posterior was the same.
The four approaches were:
1. TMB: EB combined with a Gaussian approximation via `TMB`,
2. PCA-AGQH: the PCA AGHQ grid combined with a Gaussian approximation via `aghq`,
3. NUTS: the Hamiltonian Monte Carlo (HMC) algorithm No-U-Turn Sampling (NUTS) using Stan [@carpenter2017stan] via the `tmbstan` package [@monnahan2018no].
The dimension of the latent field is $N = 491$ and the dimension of the hyperparameters is $m = 24$.
Settings used for each inferential method are provided in Table \ref{tab:inference-methods}.
For the deterministic methods, following inference we simulated hyperparameter and latent field samples.
For all methods, we simulated age-sex-district specific HIV prevalence, ART coverage and HIV incidence from the latent field and hyperparameter posteriors.
<!-- Note: eventually this figure should be generated using the algorithm proposed in the paper -->
Example model outputs from `TMB` are illustrated in Figure \ref{fig:naomi-results}.
The \textsc{R} [@r] code used to produce all results we describe below is available at `github.com/athowes/elgm-inf`.
We used `orderly` [@orderly] for reproducible research, `ggplot2` for data visualisation [@wickham2016ggplot2] and `rticles` [@allaire2022rticles] for reporting via `rmarkdown` [@allaire2022rmarkdown].

```{r naomi-results, fig.cap="District-level model outputs for adults aged 15-49. Inference conducted with \\texttt{TMB}."}
knitr::include_graphics("depends/naomi_results.png")
```

\begin{table}[]
\small
\begin{tabularx}{\textwidth}{p{0.15\linewidth}p{0.15\linewidth}p{0.6\linewidth}}
\toprule
Name & Software & Details \\
\midrule
TMB & \texttt{TMB} & Empirical Bayes, $1000$ samples \\
PCA-AGHQ & \texttt{aghq} & $k = 3, s = 8$, $1000$ samples \\
NUTS & \texttt{tmbstan} & $4$ chains of $20000$ iterations with the first $10000$ iterations of each chain discarded as warmup, then thinned by a factor of $20$. HMC parameters set to default for software. \\
\bottomrule
\end{tabularx}
\caption{A summary of settings used for each inferential method.}
\label{tab:inference-methods}
\small
\end{table}

## NUTS convergence

We assessed the quality of our NUTS results using the potential scale reduction factor $\hat R$, bulk and tail effective sample sizes, autocorrelation decay plots, univariate traceplots, pairs density plots, and NUTS specific divergent transition and energy assessments.
Full details are provided in the appendix.
We  treat these results from NUTS as a gold-standard to which other inferential methods are compared.

## Model assessment \label{sec:model-assessment}

We performed posterior predictive checks to assess the coverage of our estimates via the uniformity of the data within each posterior marginal distribution.

## Inference comparison

We used three methods to assess the accuracy of posterior distributions produced by each inferential method as compared with those from NUTS: (1) Kolmogorov-Smirnov tests, (2) maximum mean discrepancy, and (3) Pareto-smoothed importance sampling.
Our primary applied interest is in comparing the accuracy of model outputs, rather than the internal hyperparameters or latent field parameters.
That said, obtaining accurate inferences for these internal parameters is also relevant.

### Kolmogorov-Smirnov tests

Let $\{\theta_i\}_{i = 1}^n$ be posterior marginal samples from some quantity with empirical cumulative distribution (ECDF) function $F(\vartheta) = \frac{1}{n} \sum_{i = 1}^n \mathbb{I}_{\theta_i \leq \vartheta}$.
The two-sample Kolmogorov-Smirnov (KS) test statistic [@smirnov1948table] is given by the maximum absolute difference between two ECDFs.
For each method we compare the KS statistics
\begin{equation*}
D_\bullet = \sup_\vartheta | F_\texttt{NUTS}(\vartheta) - F_\bullet(\vartheta)|.
\end{equation*}
See a summary of the results in Table and Figure \ref{fig:ks}, and full results available in the appendix.

```{r ks, fig.cap="Results of Kolmogorov-Smironv tests analysis."}
qplot(1:10, 1:10) + theme_minimal()
```

```{r}
ks_summary <- readRDS("depends/ks_summary_out.rds")

# gt::gt(ks_summary) %>% gt::as_latex()
```

### Maximum mean discrepancy

To write.
See a summary of the results in Table and Figure \ref{fig:mmd}, and full results available in the appendix.

```{r mmd, fig.cap="Results of maximum mean discrepancy analysis."}
qplot(1:10, 1:10) + theme_minimal()
```

### Pareto-smoothed importance sampling

To write.
See a summary of the results in Table and Figure \ref{fig:psis}, and full results available in the appendix.

```{r psis, fig.cap="Results of Pareto-smoothed importance sampling analysis."}
qplot(1:10, 1:10) + theme_minimal()
```

# Discussion\label{sec:conclusions}

We developed an approximate Bayesian inference algorithm motivated by a challenging problem in small-area estimation of HIV in low resource settings.
For the simplified Naomi model in Malawi (Section \ref{sec:results}) our method is demonstrated to be more accurate than the EB Gaussian approximation currently in use, and substantially faster than NUTS.
We anticipate that our method could be added to the Naomi web interface as an alternative to `TMB`.
Analysts might quickly iterate over model options using the faster, less accurate inference approach, switching to the slower, more accurate approach once they are happy with the results.

We provide a flexible implementation of the algorithm, building on the `TMB` and `aghq` \textsc{R} packages.
In doing so, we hope our work enables use of deterministic inference algorithms for ELGMs in applied settings, as well as further methodological exploration of their accuracy and limitations.
Among the ELGMs structures of particular interest in spatial epidemiology, many of which are included in the structure of Naomi, are: aggregated Gaussian process models [@nandi2020disaggregation], evidence synthesis models [@amoah2020geostatistical].
Although our method is designed for ELGMs, it is possible to use it outside this class, as it is compatible with any model with a `TMB` \textsc{C++} template.

In our case study we demonstrated a Bayesian workflow for deterministic inference methods.
We retained the ability to draw samples from the posterior distributions of interest, facilitating use of posterior predictive checks (Section \ref{sec:model-assessment}).

Future work could look to implement our algorithm (Section \ref{sec:algorithm}) within probabilistic programming languages, facilitating access by a broader user-base.
This might be possible in Stan by use of the `bridgestan` package [@bridgestan] together with the adjoint-differentiated Laplace approximation of @margossian2020hamiltonian.
<!-- Note: can fit hyperparameters with Laplace on latent field using HMC via tmbstan::tmbstan(laplace = TRUE) -->
<!-- i.e. what Charles Margossian has implemented for Stan is done similarly by default in TMB -->
As well, statistical theory for the algorithm could be established by extension of Theorem 1 in @stringer2022fast.

# Acknowledgements {-}

AH was supported by the EPSRC Centre for Doctoral Training in Modern Statistics and Statistical Machine Learning (EP/S023151/1), and conducted part of this research while an International Visiting Graduate Student at the University of Waterloo.
AH and JWE were supported by the Bill and Melinda Gates Foundation (OPP1190661, OPP1164897).
SRF was supported by the EPSRC (EP/V002910/2).
JWE was supported by UNAIDS and National Institute of Allergy and Infectious Disease of the National Institutes of Health (R01AI136664).
This research was supported by the MRC Centre for Global Infectious Disease Analysis (MR/R015600/1), jointly funded by the UK Medical Research Council (MRC) and the UK Foreign, Commonwealth \& Development Office (FCDO), under the MRC/FCDO Concordat program and is also part of the EDCTP2 programme supported by the European Union.
