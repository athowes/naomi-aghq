---
title: Appendix to "Fast approximate Bayesian inference of HIV indicators using PCA adaptive Gauss-Hermite quadrature"
author:
  - Adam Howes^[Department of Mathematics, Imperial College London]
  - Alex Stringer^[Department of Statistics and Actuarial Science, University of Waterloo]
  - Seth R. Flaxman^[Department of Computer Science, Oxford University]
  - Jeffrey W. Eaton^[Harvard T.H. Chan School of Public Health, Harvard University]
output:
  pdf_document:
    toc: yes
    number_sections: yes
    keep_tex: yes
    includes:
      in_header: preamble.tex
bibliography: citations.bib
cls: imsart.cls
---

```{r echo = FALSE}
options(scipen = 100)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dpi = 320,
  cache = TRUE,
  out.width = "95%",
  fig.align = "center",
  fig.pos = "!h",
  out.extra = ""
)

knitr::opts_chunk$set()
```

\clearpage

\setcounter{table}{0}  
\renewcommand{\thetable}{S\arabic{table}} 
\setcounter{figure}{0} 
\renewcommand{\thefigure}{S\arabic{figure}}
\setcounter{section}{0} 
\renewcommand{\thesection}{S\arabic{section}}

\clearpage

# Simplified Naomi model description \label{sec:math}

In this section we describe the simplified Naomi model [@eaton2021naomi] in complete detail.

## Background

### Indexing

Consider the most recent national household survey with HIV testing which has taken place in the country of interest.
Let $x \in \{1, \ldots, n\}$ be district, $s \in \{\text{F}, \text{M}\}$ be sex, and $a \in \{\text{0-5}, \text{5-10}, \ldots, \text{75-80}, \text{80+}\}$ be five-year age groups.
Each district is located within a correspodning Spectrum [@stover2010spectrum] region $R_x$.
As short-hand, we write $a = l$ to refer to the age group with lower bound $l$, e.g. $a = 20$ for $a = \text{20-25}$.

We index the known quantity population size $N_{x, s, a}$ by district, sex and age-band, as well as the following unknown quantities:

* HIV prevalence $\rho_{x, s, a} \in [0, 1]$,
* ART coverage $\alpha_{x, s, a} \in [0, 1]$,
* annual HIV incidence rate $\lambda_{x, s, a} > 0$, and
* proportion of HIV positive persons recently infected $\kappa_{x, s, a} \in [0, 1]$.

Sometimes data are observed at an aggregate level, rather than the more granular modelled level.
We use $\{\cdot\}$ to generically refer to a aggregate set over which an observation is made, e.g. $\{a\} = \{\text{15-19}, \ldots, \text{45-49}\}$ for the adult age range 15-49.
The notation $\sum_{\{x\}}$ is used as shorthand for $\sum_{x \in \{x\}}$.
Analogous notion is used for sums over $\sum_{a \in \{a\}}$ and $\sum_{s \in \{s\}}$.

### Structured random effects

We use structured random effects to enable partial pooling of information across units assessed as being similar, such as those belonging to neighbouring districts or adjacent age groups.
Let $\bu$ be a generic random effect, with length $\dim(\bu) > 1$.
Three types of structured random effects are used in the model:

1. We specify the first order auto-regressive model by $\bu \sim \text{AR}1(\sigma, \phi)$ such that
\begin{align}
u_1 &\sim \left( 0, \frac{1}{1 - \rho^2} \right), \\
u_i &= \rho u_{i - 1} + \epsilon_i, \quad i = 2, \ldots, \dim(\bu),
\end{align}
where $\epsilon_i \sim \mathcal{N}(0, 1)$ are independent and identically distributed (IID) Gaussian random variables, $\sigma > 0$ is the marginal standard deviation, and $|\rho| < 1$ is the (lag-one) correlation parameter.
2. We use $\bu \sim \text{ICAR}(\sigma)$ to refer to the Besag intrinsic conditional auto-regressive model (ICAR) [@besag1991bayesian] with full conditionals
\begin{equation}
u_i \, | \, \bu_{-i} \sim \mathcal{N} \left(\frac{\sum_{j: j \sim i} u_j}{n_{\delta i}}, \frac{\sigma^2}{n_{\delta i}}\right),
\end{equation}
where $\bu_{-i}$ is $\bu$ with the $i$th element removed i.e. $(u_1, \ldots, u_{i - 1}, u_{i + 1}, \ldots, u_{\dim(\bu)})$, $j \sim i$ if the units $i$ and $j$ are defined as adjacent, $n_{\delta i} = |\{j:j \sim i\}|$ is the total number of adjacent units, and $\sigma > 0$ is the marginal standard deviation.
We follow recommendations of @freni2018note on scaling of precision matrices, disconnected adjacency graph components, and islands.
3. For the reparameterised Besag-York-Mollie model [BYM2; @simpson2017penalising], we write $\bu \sim \text{BYM}2(\sigma, \phi)$, where $\bu$ is comprised of a spatially structured ICAR component $\bv$ with proportion $\phi \in (0, 1)$ and spatially unstructured IID component $\w$ with proportion $1 - \phi$, both scaled to have generalised variance equal to one, and $\sigma > 0$ is the marginal standard deviation such that
\begin{equation}
\bu = \sigma \left( \sqrt\phi \cdot \bv + \sqrt{1 - \phi} \cdot \w \right).
\end{equation}

### Complex survey design

We assume the household survey was run according to a complex survey design where each individual $j$ in the population $U$ has non-zero probability $\pi_j \in (0, 1)$ of appearing in the sample $S \subseteq U$. Suppose we observe an outcome $\theta_j \in \{0, 1\}$ for $j \in S$.
Let $w_j = 1 / \pi_j \times 1 / \omega_j$ be design weights, where $\omega_j$ is a non-response factor, then a survey weighted mean is given by
\begin{equation}
\hat \theta = \frac{\sum_{j \in S} w_j \theta_j}{\sum_{j \in S} w_j}.
\end{equation}
We account for survey weighting in the variance via the Kish effective sample size [@kish1965survey]
\begin{equation}
m^{\theta} = \frac{\left(\sum_{j \in S} w_j\right)^2}{\sum_{j \in S} w_j^2}.
\end{equation}
The observed number of indicator cases is then $y^{\theta} = m^{\theta} \cdot \hat \theta$.
To make these calculations we used the `survey` \textsc{R} package [@lumley2004analysis]

## Process specification

\begin{table}[h]
\centering
\begin{tabularx}{\textwidth}{llXX}
\toprule
& Model component & Latent field & Hyperparameter \\ 
\midrule
\ref{sec:hiv-prev} & HIV prevalence & $22 + 5n$ & 9 \\ 
\ref{sec:art-cov} & ART coverage & $25 + 5n$ & 9 \\ 
\ref{sec:hiv-inc} & HIV incidence rate & $2 + n$ & 3 \\ 
\ref{sec:anc-test} & ANC testing & $2 + 2n$ & 2 \\ 
\ref{sec:art-attend} & ART attendance & $n$ & 1 \\ 
& Total & $51 + 14n$ & 24 \\ 
\bottomrule
\end{tabularx}
\caption{The numer of latent field parameters and hyperparameters in each model section.}
\label{tab:latent-hyper-size}
\end{table}

We now describe the hyperparameter and latent field process specification for the model.
Whereas in the main text process and likelihood specifications are given together, here we consider the likelihood equations separately (Section \ref{sec:likelihood}).
Table \ref{tab:latent-hyper-size} gives the number of latent field parameters and hyperparameters in each component of the model.
In the case of Malawi then $n = 32$ such that the total number of latent field parameters is $51 + 14 \cdot 32 = 499$ and the total number of hyperparameters is $24$.

<!-- 51 + 13n + 467 is the value I get from the code. 467 + 24 = 491 total -->
<!-- Need to check the discrepency -->

### HIV prevalence \label{sec:hiv-prev}

We model HIV prevalence $\rho_{x, s, a} \in [0, 1]$ on the logit scale using the linear predictor
\begin{equation}
\text{logit}(\rho_{x, s, a}) = \beta^\rho_0 + \beta_{S}^{\rho, s = \text{M}} + \bu^\rho_a + \bu_a^{\rho, s = \text{M}} + \bu^\rho_x + \bu_x^{\rho, s = \text{M}} + \bu_x^{\rho, a < 15} + \bmeta^\rho_{R_x, s, a}. \label{eq:prev}
\end{equation}
Table \ref{tab:prev} provides a description of the terms included in Equation \ref{eq:prev}.

\begin{table}[h]
\centering
\begin{tabularx}{\textwidth}{llX}
\toprule
Term & Distribution & Description \\ 
\midrule
$\beta^\rho_0$ & $\mathcal{N}(0, 5)$ & Intercept \\
$\beta_{s}^{\rho, s = \text{M}}$ & $\mathcal{N}(0, 5)$ & The difference in logit prevalence for men compared to women \\
$\bu^\rho_a$ & $\text{AR}1(\sigma_A^\rho, \phi_A^\rho)$ & Age random effects for women \\
$\bu_a^{\rho, s = \text{M}}$ & $\text{AR}1(\sigma_{AS}^\rho, \phi_{AS}^\rho)$ & Age random effects for the difference in logit prevalence for men compared to women age $a$ \\
$\bu^\rho_x$ & $\text{BYM}2(\sigma_X^\rho, \phi_X^\rho)$ & Spatial random effects for women \\
$\bu_x^{\rho, s = \text{M}}$ & $\text{BYM}2(\sigma_{XS}^\rho, \phi_{XS}^\rho)$ & Spatial random effects for the difference in logit prevalence for men compared to women in district $x$  \\
$\bu_x^{\rho, a < 15}$ & $\text{ICAR}(\sigma_{XA}^\rho)$ & Spatial random effects for the ratio of paediatric prevalence to adult women prevalence \\
$\bmeta^\rho_{R_x, s, a}$ & $-$ & Fixed offsets specifying assumed odds ratios for prevalence outside the age ranges for which data are available \\
\bottomrule
\end{tabularx}
\caption{Terms included in the linear predictor for HIV prevalence (Equation \ref{eq:prev}).}
\label{tab:prev}
\end{table}

The two BYM2 random effects $\bu^\rho_x$ and $\bu_x^{\rho, s = \text{M}}$ are comprised of the following unit scaled spatially structured $\{\bv_x^{\rho}, \bv_x^{\rho, s = \text{M}}\}$ and spatially unstructured $\{\w_x^{\rho}, \w_x^{\rho, s = \text{M}}\}$ components, respectively
\begin{align}
\bu_x^{\rho} &= \sigma_{X}^\rho \left( \sqrt\phi_{X}^\rho \cdot \bv_x^{\rho} + \sqrt{1 - \phi_{X}^\rho} \cdot \w_x^{\rho} \right), \\
\bu_x^{\rho, s = \text{M}} &= \sigma_{XS}^\rho \left( \sqrt\phi_{XS}^\rho \cdot \bv_x^{\rho, s = \text{M}} + \sqrt{1 - \phi_{XS}^\rho} \cdot \w_x^{\rho, s = \text{M}} \right).
\end{align}
We use half-normal priors for the standard deviation terms
\begin{equation}
\{\sigma_A^\rho, \sigma_{AS}^\rho, \sigma_X^\rho, \sigma_{XS}^\rho, \sigma_{XA}^\rho\} \sim \mathcal{N}^{+}(0, 2.5),
\end{equation}
uniform priors for the AR1 correlation parameters
\begin{equation}
\{\phi_A^\rho, \phi_{AS}^\rho\} \sim \mathcal{U}(-1, 1),
\end{equation}
and beta priors for the BYM2 proportion parameters
\begin{equation}
\{\phi_X^\rho, \phi_{XS}^\rho\} \sim \text{Beta}(0.5, 0.5).
\end{equation}

<!-- Latent field size -->
<!-- 1 + 1 + 10 + 10 + n + n + n = 36 + 3n -->
<!-- Hyperparameter size -->
<!-- 5 + 2 + 2 -->

### ART coverage \label{sec:art-cov}

We model ART coverage $\alpha_{x, s, a} \in [0, 1]$ on the logit scale using the linear predictor
\begin{equation}
\text{logit}(\alpha_{x, s, a}) = \beta^\alpha_0 + \beta_{S}^{\alpha, s = \text{M}} + \bu^\alpha_a + \bu_a^{\alpha, s = \text{M}} + \bu^\alpha_x + \bu_x^{\alpha, s = \text{M}} + \bu_x^{\alpha, a < 15} + \bmeta^\alpha_{R_x, s, a} 
\end{equation}
with terms and priors analogous to the HIV prevalence process model in Section \ref{sec:hiv-prev} above.

<!-- Latent field size -->
<!-- 1 + 1 + 13 + 10 + n + n + n = 36 + 3n -->
<!-- Hyperparameter size -->
<!-- 5 + 2 + 2 -->

### HIV incidence rate \label{sec:hiv-inc}

We model HIV incidence rate $\lambda_{x, s, a} > 0$ on the log scale using the linear predictor
\begin{equation}
\log(\lambda_{x, s, a}) = \beta_0^\lambda + \beta_S^{\lambda, s = \text{M}} + \log(\rho_{x}^{\text{15-49}}) + \log(1 - \omega \cdot \alpha_{x}^{\text{15-49}}) + \bu_x^\lambda + \bmeta_{R_x, s, a}^\lambda. \label{eq:inc}
\end{equation}
Table \ref{tab:inc} provides a description of the terms included in Equation \ref{eq:inc}.

<!-- \citet{eaton2019estimation} -->

\begin{table}[h]
\centering
\begin{tabularx}{\textwidth}{llX}
\toprule
Term & Distribution & Description \\ 
\midrule
$\beta^\lambda_0$ & $\mathcal{N}(0, 5)$ & Intercept term proportional to the average HIV transmission rate for untreated HIV positive adults \\
$\beta_S^{\lambda, s = \text{M}}$ & $\mathcal{N}(0, 5)$ & The log incidence rate ratio for men compared to women \\
$\rho_{x}^{\text{15-49}} = \frac{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a} \cdot \rho_{x, s, a}}{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a}}$ & $-$ & The HIV prevalence among adults 15-49 calculated by aggregating age-specific HIV prevalences \\
$\alpha_{x}^{\text{15-49}} = \frac{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a} \cdot \rho_{x, s, a} \cdot \alpha_{x, s, a}}{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a} \cdot \rho_{x, s, a}}$ & $-$ & The ART coverage among adults 15-49 calculated by aggregating age-specific ART coverages \\
$\omega = 0.7$ & $-$ & Average reduction in HIV transmission rate per increase in population ART coverage fixed based on inputs to the Estimation and Projection Package (EPP) model \\
$\bu_x^\lambda$ & $\mathcal{N}(0, \sigma^\lambda)$  & IID spatial random effects with $\sigma^\lambda \sim \mathcal{N}^+(0, 1)$ \\
$\bmeta^\lambda_{R_x, s, a}$ & $-$ & Fixed log incidence rate ratios by sex and age group calculated from Spectrum model output \\
\bottomrule
\end{tabularx}
\caption{Terms included in the linear predictor for HIV incidence (Equation \ref{eq:inc}). Note that the only source age structure for this part of the model are $\bmeta^\lambda_{R_x, s, a}$. As Spectrum assumes that there are no new infections in children aged 5-9 or 10-14, or adults aged over 80, the posterior over new infections in these age groups is exactly zero, by definition. We remove these identically zero posteriors from any later inference comparisons.}
\label{tab:inc}
\end{table}

We model the proportion recently infected among HIV positive persons $\kappa_{x, s, a} \in [0, 1]$ as
\begin{equation}
\kappa_{x, s, a} = 1 - \exp \left(- \lambda_{x, s, a} \cdot \frac{1 - \rho_{x, s, a}}{\rho_{x, s, a}} \cdot (\Omega_T - \beta_T ) - \beta_T \right),
\end{equation}
where $\Omega_T \sim \mathcal{N}(\Omega_{T_0}, \sigma^{\Omega_T})$ is the mean duration of recent infection, and $\beta_T \sim \mathcal{N}^{+}(\beta_{T_0}, \sigma^{\beta_T})$ is the false recent ratio.
We use an informative prior for $\Omega_T$ based on the characteristics of the recent infection testing algorithm.
For PHIA surveys this is $\Omega_{T_0} = 130 \text{ days}$ and $\sigma^{\Omega_T} = 6.12 \text{ days}$, and further there is assumed to be no false recency, such that $\beta_{T_0} = 0.0$ and $\sigma^{\beta_T} = 0.0$.

<!-- Latent field size -->
<!-- 1 + 1 + n + 1 + 1 = 4 + n -->
<!-- Hyperparameter size -->
<!-- 3 -->

### ANC testing \label{sec:anc-test}

HIV prevalence $\rho_{x, a}^\text{ANC}$ and ART coverage $\alpha_{x, a}^\text{ANC}$ among pregnant women are modelled as being offset on the logit scale from the corresponding district-age indicators $\rho_{x, F, a}$ and $\alpha_{x, F, a}$ according to
\begin{align}
\text{logit}(\rho_{x, a}^{\text{ANC}}) &= \text{logit}(\rho_{x, F, a}) + \beta^{\rho^{\text{ANC}}} + \bu_x^{\rho^{\text{ANC}}} + \bmeta_{R_x, a}^{\rho^{\text{ANC}}}, \label{eq:anc1} \\
\text{logit}(\alpha_{x, a}^{\text{ANC}}) &= \text{logit}(\alpha_{x, F, a}) + \beta^{\alpha^{\text{ANC}}} + \bu_x^{\alpha^{\text{ANC}}} + \bmeta_{R_x, a}^{\alpha^{\text{ANC}}} \label{eq:anc2}.
\end{align}
Table \ref{tab:anc} provides a description of the terms included in Equation \ref{eq:anc1} and Equation \ref{eq:anc2}.

\begin{table}[h]
\centering
\begin{tabularx}{\textwidth}{llX}
\toprule
Term & Distribution & Description \\ 
\midrule
$\beta^{\theta^{\text{ANC}}}$ & $\mathcal{N}(0, 5)$ & Intercept giving the average difference between population and ANC outcomes \\
$\bu_x^{\theta^{\text{ANC}}}$ & $\mathcal{N}(0, \sigma_X^{\theta^{\text{ANC}}})$ & IID district random effects with $\sigma_X^{\theta^{\text{ANC}}} \sim \mathcal{N}^+(0, 1)$ \\ 
$\bmeta_{R_x, a}^{\theta^{\text{ANC}}}$ & $-$ & Offsets for the log fertility rate ratios for HIV positive women compared to HIV negative women and for women on ART to HIV positive women not on ART, calculated from Spectrum model outputs for region $R_x$ \\
\bottomrule
\end{tabularx}
\caption{Terms included in the linear predictors for ANC testing, with $\theta \in \{\rho, \alpha\}$ (Equation \ref{eq:prev}).}
\label{tab:anc}
\end{table}

In the full Naomi model, for adult women 15-49 the number of ANC clients $\Psi_{x, a} > 0$ are modelled as
$$
\log (\Psi_{x, a}) = \log (N_{x, \text{F}, a}) + \psi_{R_x, a} + \beta^\psi + \bu_x^\psi,
$$
where $N_{x, \text{F}, a}$ are the female population sizes, $\psi_{R_x, a}$ are fixed age-sex fertility ratios in Spectrum region $R_x$, $\beta^\psi$ are log rate ratios for the number of ANC clients relative to the predicted fertility, and $\bu_x^\psi \sim \mathcal{N}(0, \sigma^\psi)$ are district random effects.
Here we fix $\beta^\psi = 0$ and $\bu_x^\psi = \mathbf{0}$ such that $\Psi_{x, a}$ are simply constants.

<!-- Latent field size -->
<!-- 1 + n + 1 + n = 2 + 2n -->
<!-- Hyperparameter size -->
<!-- 2 --> 

### ART attendance \label{sec:art-attend}

```{r}
log_odds <- function(p) log(p / (1 - p))
logistic <- function(x) 1 / (1 + exp(-x))
# 100 * round(logistic(-4), 3)
```

Let $\gamma_{x, x'} \in [0, 1]$ be the probability that a person on ART residing in district $x$ receives ART in district $x'$.
We assume that $\gamma_{x, x'} = 0$ for $x \notin \{x, \text{ne}(x)\}$ such that individuals seek treatment only in their residing district or its neighbours $\text{ne}(x) = \{x': x' \sim x\}$, where $\sim$ is an adjacency relation, and $\sum_{x' \in \{x, \text{ne}(x)\}} \gamma_{x, x'} = 1$.
To model $\gamma_{x, x'}$ for $x \sim x'$ we use a multinomial logistic regression model, based on the log-odds ratios
\begin{equation}
\tilde \gamma_{x, x'} = \log \left( \frac{\gamma_{x, x'}}{1 - \gamma_{x, x'}} \right) = \tilde \gamma_0 + \bu_x^{\tilde \gamma}, \label{eq:log-or}
\end{equation}
where $\tilde \gamma_0 = -4$ is a fixed intercept, and $\bu_x^{\tilde \gamma} \sim \mathcal{N}(0, \sigma_X^{\tilde \gamma})$ are district random effects with $\sigma_X^{\tilde \gamma} \sim \mathcal{N}^+(0, 2.5)$.
Note that Equation \ref{eq:log-or} does not depend on $x'$, such that $\gamma_{x, x'}$ is only a function of $x$.
Choice of $\tilde \gamma_0 = -4$ implies a prior mean on $\gamma_{x, x'}$ of 1.8%, such that $(100 - 1.8 \times \text{ne}(x))\%$ of ART clients in district $x$ obtain treatment in their home district, a-priori.
We fix $\tilde \gamma_{x, x} = 0$ and recover the multinomial probabilities using the softmax
\begin{equation}
\gamma_{x, x'} = \frac{\exp(\tilde \gamma_{x, x'})}{\sum_{x^\star \in \{x, \text{ne}(x)\}} \exp(\tilde \gamma_{x, x^\star})}.
\end{equation}
Given the total number of PLHIV on ART $A_{x, s, a} = N_{x, s, a} \cdot \rho_{x, s, a} \cdot \alpha_{x, s, a}$, the number of ART clients who reside in district $x$ and obtain ART in district $x'$ are $A_{x, x', s, a} = A_{x, s, a} \cdot \gamma_{x, x'}$, and the total attending ART facilities in district $x'$ are 
\begin{equation}
\tilde A_{x', s, a} = \sum_{x \in \{x', \text{ne}(x')\}} A_{x, x', s, a}.
\end{equation}

## Likelihood specification \label{sec:likelihood}

### Household survey data

For HIV prevalence, ART coverage and recent HIV infections, denoted by $\theta \in \{\rho, \alpha, \kappa\}$, the most recent household survey furnishes weighted observations $\hat \theta_{\{x\}, \{s\}, \{a\}}$ with respective Kish effective sample sizes $m^{\theta}_{\{x\}, \{s\}, \{a\}} \in \mathbb{R}$, and observed number of cases
\begin{equation}
y^{\theta}_{\{x\}, \{s\}, \{a\}} = m^{\theta}_{\{x\}, \{s\}, \{a\}} \cdot \hat \theta_{\{x\}, \{s\}, \{a\}} \in \mathbb{R}.
\end{equation}
To model these observations, we use the following three binomial working likelihoods:

1. The number of people living with HIV (PLHIV) is
\begin{equation}
y^{\rho}_{\{x\}, \{s\}, \{a\}} \sim \text{xBin}(m^{\rho}_{\{x\}, \{s\}, \{a\}}, \rho_{\{x\}, \{s\}, \{a\}}),
\end{equation}
where
\begin{equation}
\rho_{\{x\}, \{s\}, \{a\}} = \frac{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a}}{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a}}
\end{equation}
has denominator given by the total population size.
2. The number of PLHIV on ART is
\begin{equation}
y^{\alpha}_{\{x\}, \{s\}, \{a\}} \sim \text{xBin}(m^{\alpha}_{\{x\}, \{s\}, \{a\}}, \alpha_{\{x\}, \{s\}, \{a\}}),
\end{equation}
where
\begin{equation}
\alpha_{\{x\}, \{s\}, \{a\}} = \frac{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a} \cdot \alpha_{x, s, a}}{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a}}
\end{equation}
has denominator given by the total PLHIV.
3. The number of PLHIV recently infected
\begin{equation}
y^{\kappa}_{\{x\}, \{s\}, \{a\}} \sim \text{xBin}(m^{\kappa}_{\{x\}, \{s\}, \{a\}}, \kappa_{\{x\}, \{s\}, \{a\}}),
\end{equation}
where
\begin{equation}
\kappa_{\{x\}, \{s\}, \{a\}} = \frac{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a} \cdot \kappa_{x, s, a}}{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a}}
\end{equation}
has denominator given by the total PLHIV.

The generalised binomial $y \sim \text{xBin}(m, p)$ used above is defined for $y, m \in \mathbb{R}^+$ with $y \leq m$ such that
\begin{equation}
\log p(y) = \log \Gamma(m + 1) - \log \Gamma(y + 1) - \log \Gamma(m - y + 1) + y \log p + (m - y) \log(1 - p),
\end{equation}
where the gamma function $\Gamma$ is such that $\forall n \in \mathbb{N}$, $\Gamma(n) = (n - 1)!$.

### ANC testing data

We include ANC testing data for the year of the most recent survey.
Let $W^\text{ANC}_{\{x\}}$ be the number of ANC clients, $X^\text{ANC}_{\{x\}}$ the number of those with ascertained status, $Y^\text{ANC}_{\{x\}}$ the number of those with positive status (either known or tested) and $Z^\text{ANC}_{\{x\}}$ the number of ANC clients already on ART prior to first ANC, such that
\begin{equation}
W^\text{ANC}_{x} \geq X^\text{ANC}_{x} \geq Y^\text{ANC}_{x} \geq Z^\text{ANC}_{x},
\end{equation}
for all $x \in \{x\}$.
When ANC testing data are only available for part of a given year, we denote $m^\text{ANC} \in \{1, \ldots, 12\}$ the number of months of reported data reflected in counts for that year.
The observed number of HIV positive and already on ART among ANC clients is modelled by
\begin{align}
Y_{\{x\} }^{\text{ANC}} &\sim \text{Bin} \left(X_{\{x\} }^{\text{ANC}}, \rho_{\{x\},\{15, \ldots 45\}}^{\text{ANC}}\right), \\
Z_{\{x\} }^{\text{ANC}} &\sim \text{Bin} \left(Y_{\{x\} }^{\text{ANC}}, \alpha_{\{x\},\{15, \ldots 45\}}^{\text{ANC}}\right),
\end{align}
where prevalence and ART coverage are aggregated by the number of pregnant women $\Psi_{x, a}$
\begin{align}
\rho_{\{x\}\{a\}}^{\text{ANC}} &= \frac{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a} \cdot \rho_{x, a}^{\text{ANC}}}{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a}}, \\
\alpha_{\{x\}\{a\}}^{\text{ANC}} &= \frac{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a} \cdot \rho_{x, a}^{\text{ANC}} \cdot \alpha_{x, a}^{\text{ANC}}}{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a} \cdot \rho_{x, a}^{\text{ANC}}}.
\end{align}

### Number receiving ART

Let $\dot A_{\{x\}, \{s\}, \{a\}}$ be data for the number receiving ART
$$
\dot A_{\{x\}, \{s\}, \{a\}} = \sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} \sum_{x \sim x', x = x'} \dot A_{x', x, s, a}.
$$
We model the unobserved numbers of ART clients travelling from $x'$ to $x$ as
$$
\dot A_{x', x, s, a} \sim \text{Bin}(N_{x', s, a}, \pi_{x', x, s, a})
$$
where $\pi_{x', x, s, a} = \rho_{x', s, a} \cdot \alpha_{x', s, a} \cdot \gamma_{x', x, s, a}$. This likelihood is approximated using a normal for the sum of binomials by
$$
\dot A_{\{x\}, \{s\}, \{a\}} \sim \mathcal{N}(\tilde A_{\{x\}, \{s\}, \{a\}}, \sigma^{\tilde A}_{\{x\}, \{s\}, \{a\}})
$$
where the mean is
$$
\tilde{A}_{\{x\},\{s\}\{a\}} = \sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} \sum_{x \sim x', x = x'} N_{x', s, a} \cdot \pi_{x', x, s, a},
$$
and the variance is
$$
\left(\sigma_{\{x\},\{s\}\{a\}}^{\tilde{A}}\right)^2 = \sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} \sum_{x \sim x', x = x'} N_{x', s, a} \cdot \pi_{x', x, s, a} \cdot \left(1-\pi_{x', x, s, a}\right).
$$

## Identifiability constaints

If data are missing, some parameters are fixed to default values to help with identifiability.
In particular:

1. If survey data on HIV prevalence or ART coverage by age and sex are not available then we set $\bu_a^\theta = 0$ and $\bu_{a, s = \text{M}}^\theta = 0$ and use the average age-sex pattern of from the Spectrum offset $\bmeta_{R_x, s, a}^\theta$. For the Malawi example considered in the main text HIV prevalence and ART coverage data are not available for those aged 65+. As a result, there are $|\{\text{0-4}, \ldots, \text{50-54}\}| = 13$ age groups included for the age random effects.
2. If no ART data, either survey or ART programme, are available but data on ART coverage among ANC clients are available, the level of ART coverage is not identifiable, but spatial variation is identifiable. In this instance, overall ART coverage is determined by the Spectrum offset, and only area random effects are estimated such that $\text{logit} \left(\alpha_{x, s, a} \right) = \bu_x^\alpha + \bmeta_{R_x, s, a}^\alpha$.
3. If survey data on recent HIV infection are not included in the model, then $\beta_0^\lambda = \beta_S^{\lambda, s = \text{M}} = 0$ and $\bu_x^\lambda = \mathbf{0}$. The sex ratio for HIV incidence is determined by the sex incidence rate ratio from Spectrum in the same years and the incidence rate in all districts is modelled assuming the same average HIV transmission rate for untreated adults, but varies according to district estimates of HIV prevalence and ART coverage.

<!-- Create DAG representing Naomi model. This would likely go into the appendix, so use that notation -->

```{r simplified-naomi, fig.cap="Directed acyclic graph describing the simplified Naomi model (work in progress)."}
knitr::include_graphics("depends/simplified-naomi.pdf")
```

## Implementation

The C++ `TMB` code for the negative log-posterior of the simplified Naomi model is available from the GitHub repository `athowes/naomi-aghq`.
For ease of understanding, Table \ref{tab:tmb-lookup} provides correspondence between the mathematical notation used in Section \ref{sec:math} and the variable names used in the `TMB` code, for all hyperparameters and latent field parameters.
For further reference on the `TMB` software see @tmbdocumentation.

<!-- Use table(names(tmb$fit$par.full)) to check the below table -->

\begin{table}[p!]
\centering
\begin{tabularx}{\textwidth}{llllllll}
\toprule
Variable name & Notation & Type & Size & Domain & $\rho$ input? & $\alpha$ input? & $\lambda$ input? \\
\midrule
\texttt{logit\_phi\_rho\_x} & $\text{logit}(\phi_X^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_x} & $\log(\sigma_X^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_rho\_xs} & $\text{logit}(\phi_{XS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_xs} & $\log(\sigma_{XS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_rho\_a} & $\text{logit}(\phi_A^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_a} & $\log(\sigma_A^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_rho\_as} & $\text{logit}(\phi_{AS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_as} & $\log(\sigma_{AS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_xa} & $\log(\sigma_{XA}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_alpha\_x} & $\text{logit}(\phi_X^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_x} & $\log(\sigma_X^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{logit\_phi\_alpha\_xs} & $\text{logit}(\phi_{XS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_xs} & $\log(\sigma_{XS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{logit\_phi\_alpha\_a} & $\text{logit}(\phi_A^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_a} & $\log(\sigma_A^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{logit\_phi\_alpha\_as} & $\text{logit}(\phi_{AS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_as} & $\log(\sigma_{AS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_xa} & $\log(\sigma_{XA}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{OmegaT\_raw} & $\Omega_T$ & Hyper & 1 & $\mathbb{R}$ & & & \cmark \\
\texttt{log\_betaT} & $\log(\beta_T)$ & Hyper & 1 & $\mathbb{R}$ & & & \cmark \\
\texttt{log\_sigma\_lambda\_x} & $\log(\sigma^\lambda)$ & Hyper & 1 & $\mathbb{R}$ & & & \cmark \\
\texttt{log\_sigma\_ancrho\_x} & $\log(\sigma_X^{\rho^{\text{ANC}}})$ & Hyper & 1 & $\mathbb{R}$ & & & \\
\texttt{log\_sigma\_ancalpha\_x} & $\log(\sigma_X^{\alpha^{\text{ANC}}})$ & Hyper & 1 & $\mathbb{R}$ & & & \\
\texttt{log\_sigma\_or\_gamma} & $\log(\sigma_X^{\tilde \gamma})$ & Hyper & 1 & $\mathbb{R}$ & & & \\
\texttt{beta\_rho} & $(\beta^\rho_0, \beta_{s}^{\rho, s = \text{M}})$ & Latent & 2 & $\mathbb{R}^2$ & \cmark & & \\
\texttt{beta\_alpha} & $(\beta^\alpha_0, \beta_{S}^{\alpha, s = \text{M}})$ & Latent & 2 & $\mathbb{R}^2$ & & \cmark & \\
\texttt{beta\_lambda} & $(\beta_0^\lambda, \beta_S^{\lambda, s = \text{M}})$ & Latent & 2 & $\mathbb{R}^2$ & & & \cmark \\
\texttt{beta\_anc\_rho} & $\beta^{\rho^{\text{ANC}}}$ & Latent & 1 & $\mathbb{R}$ & & & \\
\texttt{beta\_anc\_alpha} & $\beta^{\alpha^{\text{ANC}}}$ & Latent & 1 & $\mathbb{R}$ & & & \\
\texttt{u\_rho\_x} & $\w^\rho_x$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{us\_rho\_x} & $\bv^\rho_x$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{u\_rho\_xs} & $\w_x^{\rho, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{us\_rho\_xs} & $\bv_x^{\rho, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{u\_rho\_a} & $\bu^\rho_a$ & Latent & 10 & $\mathbb{R}^{10}$ & \cmark & & \\
\texttt{u\_rho\_as} & $\bu_a^{\rho, s = \text{M}}$ & Latent & 10 & $\mathbb{R}^{10}$ & \cmark & & \\
\texttt{u\_rho\_xa} & $\bu_x^{\rho, a < 15}$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{u\_alpha\_x} & $\w^\alpha_x$ & Latent & $n$ & $\mathbb{R}^{n}$ && \cmark & \\
\texttt{us\_alpha\_x} & $\bv^\alpha_x$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{u\_alpha\_xs} & $\w_x^{\alpha, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{us\_alpha\_xs} & $\bv_x^{\alpha, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{u\_alpha\_a} & $\bu^\alpha_a$ & Latent & 13 & $\mathbb{R}^{13}$ & & \cmark & \\
\texttt{u\_alpha\_as} & $\bu_a^{\alpha, s = \text{M}}$ & Latent & 10 & $\mathbb{R}^{10}$ & & \cmark & \\
\texttt{u\_alpha\_xa} & $\bu_x^{\alpha, a < 15}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{ui\_lambda\_x} & $\bu_x^\lambda$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \cmark \\
\texttt{ui\_anc\_rho\_x} & $\bu_x^{\rho^{\text{ANC}}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \\
\texttt{ui\_anc\_alpha\_x} & $\bu_x^{\alpha^{\text{ANC}}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \\
\texttt{log\_or\_gamma} & $\bu_x^{\tilde \gamma}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \\
\bottomrule
\end{tabularx}
\caption{Correspondence between mathematical notation and variable names used in our \texttt{TMB} code. The total number of hyperparameters is 24, and the total number of latent field parameters is $51 + 14n$, where $n$ is the number of districts. We use the notation \cmark \ to refer to direct dependence of the parameter on the variable, \xmark \ to refer to no dependence, and a blank entry to refer to dependence conditional on the data.}
\label{tab:tmb-lookup}
\end{table}

<!-- Latent field size -->
<!-- 2 + 2 + 2 + 1 + 1+ 10 + 10 + 13 + 10 + 14n = 51 + 14n -->
<!-- Hyperparameter size -->
<!-- 24 -->

<!-- \clearpage -->

<!-- ```{cpp, echo=TRUE, eval=FALSE, output.var="ex", code=readLines("naomi_simple.cpp")} -->
<!-- ``` -->

\clearpage

# AGHQ and PCA-AGHQ details

## Additional figures

```{r scree, fig.cap="Most variation in the inverse curvature could be explained using far fewer than the full 24 dimensions."}
knitr::include_graphics("depends/total-variation.png")
```

```{r reduced-rank, fig.cap="The reduced rank ($s = 8$) matrix approximation to the covariance matrix is visually similar to the full rank original."}
knitr::include_graphics("depends/reduced-rank.png")
```

```{r nodes-quantiles-sd, fig.cap="Standard deviations of the quantiles of the quadrature nodes within the NUTS posterior draws varied substantially, in accordance with the marginal standard deviations shown in Figure \\ref{fig:marginal-sd}."}
knitr::include_graphics("depends/nodes-quantiles-sd.png")
```

```{r marginal-sd, fig.cap="Hyperparameters on the logit-scale had systematically higher marginal standard deviations than those on the log-scale. This is because variation on the real scale is compressed by the inverse logit and expanded by the inverse log (exponential)."}
knitr::include_graphics("depends/marginal-sd.png")
```

```{r pc-loadings, fig.cap="Principal component loadings based on the eigendecomposition of the inverse curvature."}
knitr::include_graphics("depends/pc-loadings.png")
```

## Estimated normalising constant comparison

Add here plots and description of the estimated normalising constant for different PCA-AGHQ settings.

\clearpage

# Comprehensive inference comparison

In this section we give further inference comparison results, parameter by parameter.

## Point estimates

## Distribution tests

```{r}
ks_summary <- readRDS("depends/ks-summary.rds")

ks_summary %>%
  ungroup() %>%
  filter(type == "Latent field") %>%
  select(-type) %>%
  rename(TMB = `KS(TMB, tmbstan)`, `PCA-AGHQ` = `KS(aghq, tmbstan)`) %>%
  select(Parameter, TMB, `PCA-AGHQ`) %>%
  mutate(Difference = TMB - `PCA-AGHQ`) %>%
  gt::gt() %>%
  gt::summary_rows(
   columns = c(`TMB`, `PCA-AGHQ`, Difference),
   fns = list(Average = ~ mean(.x)),
   formatter = gt::fmt_number,
   decimals = 3
  ) %>%
  gt::fmt_number(
    columns = c(`TMB`, `PCA-AGHQ`, Difference),
    decimals = 3
  ) %>%
  gt::text_transform(
    locations = gt::cells_body("Parameter"),
    fn = function(x) paste0("\\texttt{", x, "}")
  ) %>%
  gt::text_transform(
    locations = gt::cells_body("Difference"),
    fn = function(x) ifelse(x > 0, paste0("\\textbf{", x, "}"), paste0(x))
  ) %>%
  gt::as_latex() %>%
  as.character() %>%
  cat(file = "ks-summary.tex")
```

\input{ks-summary.tex}

## Pareto-smoothed importance sampling

## Maximum mean discrepancy

\clearpage

# MCMC convergence and suitability

```{r}
mcmc_out <- readRDS("depends/mcmc-out.rds")
```

We assessed MCMC convergence and suitability using a range of graphical and numerical tests.
The largest scale reduction factor $\hat R$ was `r signif(mcmc_out$max_rhat, 3)` (Figure \ref{fig:rhat}).
As such, all values of $\hat R < 1.05$.
Even thinning by a factor of 20, samples were not obtained very efficiently, resulting in the majority of effective sample size (ESS) ratios being below 0.5, with some as low as 0.1 (Figure \ref{fig:ratio}).
As a result, the number of obtained ESS varied substantially by parameter (Figure \ref{fig:ess}): the minimum was `r round(mcmc_out$ess_min, 1)`, 2.5% quantile was `r round(mcmc_out$ess_lower, 1)`, median was `r round(mcmc_out$ess_median, 1)`, 97.5% quantile was `r round(mcmc_out$ess_upper, 1)` and maximum was `r round(mcmc_out$ess_max, 1)`.
Traceplots for the parameters with the lowest ESS (`log_sigma_alpha_xs`) and highest $\hat R$ (the 10th index of `ui_lambda_x`) are shown in Figure \ref{fig:worst_trace}.
There were no divergent transitions.
<!-- Could add energy plot from @betancourt2017conceptual here. -->

```{r}
np <- readRDS("depends/nuts-params.rds")

n_divergent <- np %>%
  filter(Parameter == "divergent__") %>%
  summarise(n_divergent = sum(Value)) %>%
  pull(n_divergent)

stopifnot(n_divergent == 0)
```

```{r rhat, fig.cap="The potential scale reduction factor compares between- and within- estimates of univariate parameters. It is recommended only to use NUTS results if the value is less than 1.05, which it is for all parameters."}
knitr::include_graphics("depends/rhat.png")
```

```{r ratio, fig.cap="The efficiently, as measured by the ESS ratio, of the NUTS sampler was poor."}
knitr::include_graphics("depends/ratio.png")
```

```{r ess, fig.cap="The effective number of samples we obtained varied substantially between parameters."}
knitr::include_graphics("depends/ess.png")
```

```{r worst_trace, fig.cap="Traceplots of the parameters with the lowest ESS and highest scale reduction factor."}
knitr::include_graphics("depends/worst-trace.png")
```

```{r rho_a, fig.cap="Variation between units can be explained either by high correlation and high variance, or by low correlation and low variance. As such, the AR1 hyperparameters had correlated posteriors. It is this correlation which we made use of with PCA-AGHQ."}
knitr::include_graphics("depends/rho_a.png")
```

```{r alpha_x, fig.cap="In contrast to the AR1 hyperparameters, the BYM2 hyperparameter posteriors are much less correlated."}
knitr::include_graphics("depends/alpha_x.png")
```

\clearpage

# Algorithm using Laplace latent field marginals 

1. Calculate the mode, Hessian at the mode, lower Cholesky, and Laplace approximation
\begin{align}
\hat{\btheta} &= \argmax_{\btheta} {\tilde p_\texttt{LA}(\btheta, \y)}, \\
\hat{\mathbf{H}} &= - \frac{\partial^2}{\partial \btheta \partial \btheta^\top} \log \tilde p_\texttt{LA}(\btheta, \y) \rvert_{\btheta = \hat \btheta}, \\
\hat{\mathbf{H}}^{-1} &= \hat{\mathbf{L}} \hat{\mathbf{L}}^\top, \\
\tilde p_\texttt{LA}(\btheta, \y) &= \frac{p(\y, \x, \btheta)}{\tilde p_\texttt{G}(\x \, | \, \btheta, \y)} \Big\rvert_{\x = \hat \x(\btheta)},
\end{align}
where $\tilde p_\texttt{G}(\x \, | \, \btheta, \y) = \mathcal{N}(\x \, | \, \hat \x(\btheta), \hat{\mathbf{H}}(\btheta)^{-1})$ is a Gaussian approximation to $p(\x \, | \, \btheta, \y)$ with mode and precision matrix given by
\begin{align}
\hat \x(\btheta) &= \argmax_\x \log p(\y, \x, \btheta), \\
\hat{\mathbf{H}}(\btheta) &= - \frac{\partial^2}{\partial \x \partial \x^\top} \log p(\y, \x, \btheta) \rvert_{\x = \hat \x(\btheta)}.
\end{align}
2. Generate a set of nodes $\bu \in \mathcal{Q}(m, k)$ and weights $\omega: \bu \to \mathbb{R}$ from a Gauss-Hermite quadrature rule with $k$ nodes per dimension.
Adapt these nodes based on the mode and lower Choleksy via $\btheta(\bu) = \hat{\btheta} + \mathbf{L} \bu$.
Use this quadrature rule to calculate the normalising constant $\tilde p_{\texttt{AQ}}(\y)$ as follows
\begin{equation}
\tilde p_{\texttt{AQ}}(\y) = \sum_{\bu \in \mathcal{Q}(m, k)} \tilde p_\texttt{LA}(\btheta(\bu), \y) \omega(\bu). \label{eq:evidence1}
\end{equation}
3. For $i \in [N]$ generate $l$ nodes $x_i(\bv)$ via a Gauss-Hermite quadrature rule $\bv \in \mathcal{Q}(1, l)$ adapted based on the mode $\hat \x(\btheta)_i$ and standard deviation $\sqrt{\text{diag}[\hat{\mathbf{H}}(\btheta)^{-1}]_i}$ of the Gaussian marginal.
A value of $l \geq 4$ is recommended to enable B-spline interpolation.
For $x_i \in \{ x_i(\bv) \}_{\bv \in \mathcal{Q}(1, l)}$  and $\btheta \in \{ \btheta(\bu) \}_{\bu \in \mathcal{Q}(m, k)}$ calculate the modes and Hessians
\begin{align}
\hat \x_{-i}(x_i, \btheta) &= \argmax_{\x_{-i}} \log p(\y, x_i, \x_{-i}, \btheta), \\
\hat{\mathbf{H}}_{-i, -i}(x_i, \btheta) &= - \frac{\partial^2}{\partial \x_{-i} \partial \x_{-i}^\top} \log p(\y, x_i, \x_{-i}, \btheta) \rvert_{\x_{-i} = \hat \x_{-i}(x_i, \btheta)},
\end{align}
where optimisation to obtain $\hat \x_{-i}(x_i, \btheta)$ can be initialised at $\hat \x(\btheta)_{-i}$.
4. For $x_i \in \{ x_i(\bv) \}_{\bv \in \mathcal{Q}(1, l)}$ calculate
\begin{equation}
\end{equation}
where
$$
\tilde p_\texttt{LA}(x_i, \y) = \sum_{\bu \in \mathcal{Q}(m, k)} \tilde p_\texttt{LA}(x_i, \btheta(\bu), \y) \omega(\bu).
$$
and
$$
\tilde p_\texttt{LA}(x_i, \btheta, \y) = \frac{p(x_i, \x_{-i}, \btheta, \y)}{\tilde p_\texttt{G}(\x_{-i} \, | \, x_i, \btheta, \y)} \Big\rvert_{\x_{-i} = \hat \x_{-i}(x_i, \btheta)}.
$$
Although Equation \ref{eq:laplace-marginal} can be calculated using the estimate of the evidence given in Equation \ref{eq:evidence1} it is more numerically accurate, and requires little extra computation, to use the estimate
$$
\tilde p_{\texttt{AQ}}(\y) = \sum_{\bv \in \mathcal{Q}(1, l)} \tilde p_\texttt{LA}(x_i(\bv), \y) \omega(\bv)
$$

5. Given $\{x_i(\bv), \tilde p_\texttt{AQ}(x_i(\bv) \, | \, \y)\}_{\bv \in \mathcal{Q}(1, l)}$ create a spline interpolant to each posterior marginal on the log-scale. Samples, and thereby relevant posterior marginal summaries, may be obtained using inverse transform sampling.

<!-- ```{r algorithm-flowchart, fig.cap="Flowchart describing the algorithm we propose (work in progress)."} -->
<!-- knitr::include_graphics("depends/algorithm-flowchart.pdf") -->
<!-- ``` -->

\clearpage

# References {#references .unnumbered}
