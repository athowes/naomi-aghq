---
title: Appendix to "Fast approximate Bayesian inference for small-area estimation of HIV indicators using the Naomi model"
author:
  - Adam Howes^[Department of Mathematics, Imperial College London]
  - Alex Stringer^[Department of Statistics and Actuarial Science, University of Waterloo]
  - Seth R. Flaxman^[Department of Computer Science, Oxford University]
  - Jeffrey W. Eaton^[Department of Infectious Disease Epidemiology, Imperial College London]
output:
  pdf_document:
    toc: yes
    number_sections: yes
    keep_tex: yes
    includes:
      in_header: preamble.tex
bibliography: citations.bib
cls: imsart.cls
---

```{r echo = FALSE}
options(scipen = 100)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dpi = 320,
  cache = TRUE,
  out.width = "95%",
  fig.align = 'center'
)
```

\newpage

```{=tex}
\setcounter{table}{0}  
\renewcommand{\thetable}{S\arabic{table}} 
\setcounter{figure}{0} 
\renewcommand{\thefigure}{S\arabic{figure}}
\setcounter{section}{0} 
\renewcommand{\thesection}{S\arabic{section}}
```

\newpage

# Simplified Naomi model description \label{sec:math}

In this section we describe the simplified Naomi model [@eaton2021naomi] considered in the main text in more complete detail.

## Background

### Indexing

Consider the most recent national household survey with HIV testing which has taken place in the country of interest.
Let $x \in \{1, \ldots, n\}$ refer to a district located within the Spectrum [@stover2010spectrum] region $R_x$.
Let $s \in \{\text{F}, \text{M}\}$ be sex, and $a \in \{\text{0-5}, \text{5-10}, \ldots, \text{75-80}, \text{80+}\}$ be five-year age groups.
As short-hand, we write $a = l$ to refer to the age group with lower bound $l$, e.g. $a = 20$ for $a = \text{20-25}$.
We index the known quantity population size $N_{x, s, a}$ by district, sex and age-band, as well as the following unknown quantities: HIV prevalence $\rho_{x, s, a} \in [0, 1]$, ART coverage $\alpha_{x, s, a} \in [0, 1]$, annual HIV incidence rate $\lambda_{x, s, a} > 0$, and proportion of HIV positive persons recently infected $\kappa_{x, s, a} \in [0, 1]$.
Sometimes data are observed at an aggregate level, rather than the more granular modelled level.
In this instance, we use $\{\cdot\}$ to generically refer to a aggregate set over which an observation is made, e.g. $\{a\} = \{\text{15-19}, \ldots, \text{45-49}\}$ for the adult age range 15-49.
We let $\sum_{\{x\}}$ be used as shorthand for $\sum_{x \in \{x\}}$, and likewise for $s$ and $a$.
In the main text we use a more concise, but less descriptive, approach.

### Structured random effects

We use use structured random effects to enable partial pooling of information across units assessed as being similar, such as those belonging to neighbouring districts or adjacent age-bands.
Let $u$ be a generic random effect, with length $\dim(u)$.
Three types of structured random effects are used in the model.
First, we specify the first order auto-regressive model by $u \sim \text{AR}1(\sigma, \phi)$ such that
\begin{align*}
u_1 &\sim \left( 0, \frac{1}{1 - \rho^2} \right), \\
u_i &= \rho u_{i - 1} + \epsilon_i, \quad i = 2, \ldots, \dim(u)
\end{align*}
where $\epsilon_i \sim \mathcal{N}(0, 1)$ are independent and identically distributed (IID) Gaussian random variables, $\sigma > 0$ is the marginal standard deviation, and $|\rho| < 1$ is the (lag-one) correlation parameter.
Second, we use $u \sim \text{ICAR}(\sigma)$ to refer to the Besag intrinsic conditional auto-regressive model (ICAR) [@besag1991bayesian] with full conditionals
$$
u_i \, | \, u_{-i} \sim \mathcal{N} \left(\frac{\sum_{j: j \sim i} u_j}{n_{\delta i}}, \frac{\sigma^2}{n_{\delta i}}\right),
$$
where $u_{-i}$ is $u$ with the $i$th element removed i.e. $(u_1, \ldots, u_{i - 1}, u_{i + 1}, \ldots, u_{\dim(u)})$, $j \sim i$ if the units $i$ and $j$ are defined as adjacent, $n_{\delta i} = |\{j:j \sim i\}|$ is the total number of adjacent units, and $\sigma > 0$ is the marginal standard deviation.
We follow recommendations of @freni2018note on scaling of precision matrices, disconnected adjacency graph components, and islands.
Third, for the reparameterised Besag-York-Mollie model (BYM2) [@simpson2017penalising], we write $u \sim \text{BYM}2(\sigma, \phi)$, where $u$ is comprised of a spatially structured ICAR component $v$ with proportion $\phi \in (0, 1)$ and spatially unstructured IID component $w$ with proportion $1 - \phi$, both scaled to have generalised variance equal to one, and $\sigma > 0$ is the marginal standard deviation such that
$$
u = \sigma \left( \sqrt\phi \cdot v + \sqrt{1 - \phi} \cdot w \right).
$$

### Complex survey design

We assume the household survey was run according to a complex survey design where each individual $j$ in the population $U$ has non-zero probability $\pi_j \in (0, 1)$ of appearing in the sample $S \subseteq U$. Suppose we observe an outcome $\theta_j \in \{0, 1\}$ for $j \in S$.
Let $w_j = 1 / \pi_j \times 1 / \omega_j$ be design weights, where $\omega_j$ is a non-response factor, then a survey weighted mean is given by
$$
\hat \theta = \frac{\sum_{j \in S} w_j \theta_j}{\sum_{j \in S} w_j}.
$$
We account for survey weighting in the variance via the Kish effective sample size [@kish1965survey]
$$
m^{\hat \theta} = \frac{\left(\sum_{j \in S} w_j\right)^2}{\sum_{j \in S} w_j^2}.
$$
The observed number of indicator cases is then $y^{\hat \theta} = m^{\hat \theta} \cdot \hat \theta$.
To make these computations we use the `survey` \textsc{R} package [@lumley2004analysis].

## Process specification

```{=tex}
\begin{table}[h]
\centering
\begin{tabularx}{\textwidth}{llXX}
\toprule
& Model component & Latent field & Hyperparameter \\ 
\midrule
\ref{sec:hiv-prev} & HIV prevalence & $22 + 5n$ & 9 \\ 
\ref{sec:art-cov} & ART coverage & $25 + 5n$ & 9 \\ 
\ref{sec:hiv-inc} & HIV incidence rate & $2 + n$ & 3 \\ 
\ref{sec:anc-test} & ANC testing & $2 + 2n$ & 2 \\ 
\ref{sec:art-attend} & ART attendance & $n$ & 1 \\ 
& Total & $51 + 14n$ & 24 \\ 
\bottomrule
\end{tabularx}
\label{tab:latent-hyper-size}
\caption{The numer of latent field parameters and hyperparameters in each model section.}
\end{table}
```

We now describe the hyperparameter and latent field process specification for the model.
Whereas in the main text process and likelihood specifications are written together, here we consider the likelihood equations separately in Section \ref{sec:likelihood} to follow.
Table \ref{tab:latent-hyper-size} gives the number of latent field parameters and hyperparameters in each component of the model.
In the case of Malawi then $n = 32$ such that the total number of latent field parameters is $51 + 14 \cdot 32 = 499$ and the total number of hyperparameters is $24$.

<!-- Had previously been getting a figure of 491 somewhere -- which is 51 + 14n + 24. Something going on there? -->

### HIV prevalence \label{sec:hiv-prev}

We model HIV prevalence $\rho_{x, s, a} \in [0, 1]$ on the logit scale using the linear predictor
$$
\text{logit}(\rho_{x, s, a}) = \beta^\rho_0 + \beta_{S}^{\rho, s = \text{M}} + u^\rho_a + u_a^{\rho, s = \text{M}} + u^\rho_x + u_x^{\rho, s = \text{M}} + u_x^{\rho, a < 15} + \eta^\rho_{R_x, s, a}. 
$$
The term $\beta^\rho_0 \sim \mathcal{N}(0, 5)$ is an intercept, and $\beta_{s}^{\rho, s = \text{M}} \sim \mathcal{N}(0, 5)$ is the difference in logit prevalence for men compared to women.
The terms $u^\rho_a \sim \text{AR}1(\sigma_A^\rho, \phi_A^\rho)$ are age random effects for women, and $u_a^{\rho, s = \text{M}} \sim \text{AR}1(\sigma_{AS}^\rho, \phi_{AS}^\rho)$ are age random effects for the difference in logit prevalence for men compared to women age $a$.
The terms $u^\rho_x \sim \text{BYM}2(\sigma_X^\rho, \phi_X^\rho)$ are spatial random effects for women, and $u_x^{\rho, s = \text{M}} \sim \text{BYM}2(\sigma_{XS}^\rho, \phi_{XS}^\rho)$ are spatial random effects for the difference in logit prevalence for men compared to women in district $x$.
The terms $u_x^{\rho, a < 15} \sim \text{ICAR}(\sigma_{XA}^\rho)$ are spatial random effects for the ratio of paediatric prevalence to adult women prevalence.
Finally, $\eta^\rho_{R_x, s, a}$ are fixed offsets specifying assumed odds ratios for prevalence outside the age ranges for which data are available.
The two BYM2 random effects are comprised of the following unit scaled spatially structured $\{v_x^{\rho}, v_x^{\rho, s = \text{M}}\}$ and spatially unstructured $\{w_x^{\rho}, w_x^{\rho, s = \text{M}}\}$ components
\begin{align*}
u_x^{\rho} &= \sigma_{X}^\rho \left( \sqrt\phi_{X}^\rho \cdot v_x^{\rho} + \sqrt{1 - \phi_{X}^\rho} \cdot w_x^{\rho} \right), \\
u_x^{\rho, s = \text{M}} &= \sigma_{XS}^\rho \left( \sqrt\phi_{XS}^\rho \cdot v_x^{\rho, s = \text{M}} + \sqrt{1 - \phi_{XS}^\rho} \cdot w_x^{\rho, s = \text{M}} \right).
\end{align*}
We use half-normal priors for the standard deviation terms
$$
\{\sigma_A^\rho, \sigma_{AS}^\rho, \sigma_X^\rho, \sigma_{XS}^\rho, \sigma_{XA}^\rho\} \sim \mathcal{N}^{+}(0, 2.5),
$$
uniform priors for the AR1 correlation parameters
$$
\{\phi_A^\rho, \phi_{AS}^\rho\} \sim \mathcal{U}(-1, 1),
$$
and beta priors for the BYM2 proportion parameters
$$
\{\phi_X^\rho, \phi_{XS}^\rho\} \sim \text{Beta}(0.5, 0.5).
$$

<!-- Latent field size -->
<!-- 1 + 1 + 10 + 10 + n + n + n = 36 + 3n -->
<!-- Hyperparameter size -->
<!-- 5 + 2 + 2 -->

### ART coverage \label{sec:art-cov}

We model ART coverage $\alpha_{x, s, a} \in [0, 1]$ on the logit scale using the linear predictor
$$
\text{logit}(\alpha_{x, s, a}) = \beta^\alpha_0 + \beta_{S}^{\alpha, s = \text{M}} + u^\alpha_a + u_a^{\alpha, s = \text{M}} + u^\alpha_x + u_x^{\alpha, s = \text{M}} + u_x^{\alpha, a < 15} + \eta^\alpha_{R_x, s, a} 
$$
with terms and priors analogous to the HIV prevalence process model in Section \ref{sec:hiv-prev} above.

<!-- Latent field size -->
<!-- 1 + 1 + 13 + 10 + n + n + n = 36 + 3n -->
<!-- Hyperparameter size -->
<!-- 5 + 2 + 2 -->

### HIV incidence rate \label{sec:hiv-inc}

We model HIV incidence rate $\lambda_{x, s, a} > 0$ on the log scale using the linear predictor
$$
\log(\lambda_{x, s, a}) = \beta_0^\lambda + \beta_S^{\lambda, s = \text{M}} + \log(\rho_{x}^{\text{15-49}}) + \log(1 - \omega \cdot \alpha_{x}^{\text{15-49}}) + u_x^\lambda + \eta_{R_x, s, a}^\lambda, \label{eq:hiv-inc}
$$
where $\beta^\lambda_0 \sim \mathcal{N}(0, 5)$ is an intercept term proportional to the average HIV transmission rate for untreated HIV positive adults and $\beta_S^{\lambda, s = \text{M}} \sim \mathcal{N}(0, 5)$ is the log incidence rate ratio for men compared to women.
The term
$$
\rho_{x}^{\text{15-49}} = \frac{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a} \cdot \rho_{x, s, a}}{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a}}
$$
is the HIV prevalence among adults 15-49 calculated by aggregating age-specific HIV prevalences, and
$$
\alpha_{x}^{\text{15-49}} = \frac{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a} \cdot \rho_{x, s, a} \cdot \alpha_{x, s, a}}{\sum_{s \in \{\text{F}, \text{M}\}} \sum_{a = 15}^{45} N_{x, s, a} \cdot \rho_{x, s, a}}
$$
is the ART coverage among adults 15-49 calculated by aggregating age-specific ART coverages.
The term $\omega$ is the average reduction in HIV transmission rate per 1% increase in population ART coverage and is fixed at $\omega = 0.7$ based on inputs to the Estimation and Projection Package (EPP) model [@eaton2019estimation].
The terms $u_x^\lambda \sim \mathcal{N}(0, \sigma^\lambda)$ with $\sigma^\lambda \sim \mathcal{N}^+(0, 1)$ are IID spatial random effects.
Finally, $\eta^\lambda_{R_x, s, a}$ specify fixed log incidence rate ratios by sex and age group calculated from Spectrum model output^[Note that these outputs are the only source of age structure for this part of the model. Furthermore, Spectrum assumes that there are no new infections in children aged 5-9 or 10-14, or adults aged over 80. A consequence is that the posterior over new infections in these age groups is exactly zero, by definition. We remove these identically zero posteriors from any inference comparisons.]

We model the proportion recently infected among HIV positive persons $\kappa_{x, s, a} \in [0, 1]$ as
$$
\kappa_{x, s, a} = 1 - \exp \left(- \lambda_{x, s, a} \cdot \frac{1 - \rho_{x, s, a}}{\rho_{x, s, a}} \cdot (\Omega_T - \beta_T ) - \beta_T \right),
$$
where $\Omega_T \sim \mathcal{N}(\Omega_{T_0}, \sigma^{\Omega_T})$ is the mean duration of recent infection, and $\beta_T \sim \mathcal{N}^{+}(\beta_{T_0}, \sigma^{\beta_T})$ is the false recent ratio.
We use an informative prior for $\Omega_T$ based on the characteristics of the recent infection testing algorithm.
For PHIA surveys this is $\Omega_{T_0} = 130 \text{ days}$ and $\sigma^{\Omega_T} = 6.12 \text{ days}$, and further we assume there is no false recency, such that $\beta_{T_0} = 0.0$ and $\sigma^{\beta_T} = 0.0$.

<!-- Latent field size -->
<!-- 1 + 1 + n + 1 + 1 = 4 + n -->
<!-- Hyperparameter size -->
<!-- 3 -->

### ANC testing \label{sec:anc-test}

HIV prevalence $\rho_{x, a}^\text{ANC}$ and ART coverage $\alpha_{x, a}^\text{ANC}$ among pregnant women are modelled as being offset on the logit scale from the corresponding district-age indicators $\rho_{x, F, a}$ and $\alpha_{x, F, a}$ according to
\begin{align*}
\text{logit}(\rho_{x, a}^{\text{ANC}}) &= \text{logit}(\rho_{x, F, a}) + \beta^{\rho^{\text{ANC}}} + u_x^{\rho^{\text{ANC}}} + \eta_{R_x, a}^{\rho^{\text{ANC}}}, \\
\text{logit}(\alpha_{x, a}^{\text{ANC}}) &= \text{logit}(\alpha_{x, F, a}) + \beta^{\alpha^{\text{ANC}}} + u_x^{\alpha^{\text{ANC}}} + \eta_{R_x, a}^{\alpha^{\text{ANC}}},
\end{align*}
where, for $\theta \in \{\rho, \alpha\}$, $\beta^{\theta^{\text{ANC}}} \sim \mathcal{N}(0, 5)$ are the average differences between population and ANC outcomes, $u_x^{\theta^{\text{ANC}}} \sim \mathcal{N}(0, \sigma_X^{\theta^{\text{ANC}}})$ are IID district random effects with $\sigma_X^{\theta^{\text{ANC}}} \sim \mathcal{N}^+(0, 1)$, and $\eta_{R_x, a}^{\theta^{\text{ANC}}}$ for are offsets for the log fertility rate ratios for HIV positive women compared to HIV negative women and for women on ART to HIV positive women not on ART, calculated from Spectrum model outputs for region $R_x$.

In the full Naomi model, for adult women 15-49 the number of ANC clients $\Psi_{x, a} > 0$ are modelled as
$$
\log (\Psi_{x, a}) = \log (N_{x, \text{F}, a}) + \psi_{R_x, a} + \beta^\psi + u_x^\psi
$$
where $N_{x, \text{F}, a}$ are the female population sizes, $\psi_{R_x, a}$ are fixed age-sex fertility ratios in Spectrum region $R_x$, $\beta^\psi$ are log rate ratios for the number of ANC clients relative to the predicted fertility, and $u_x^\psi \sim \mathcal{N}(0, \sigma^\psi)$ are district random effects.
Here we fix $\beta^\psi = u_x^\psi = 0$ such that $\Psi_{x, a}$ are simply constants.

<!-- Latent field size -->
<!-- 1 + n + 1 + n = 2 + 2n -->
<!-- Hyperparameter size -->
<!-- 2 --> 

### ART attendance \label{sec:art-attend}

```{r}
log_odds <- function(p) log(p / (1 - p))
logistic <- function(x) 1 / (1 + exp(-x))
# 100 * round(logistic(-4), 3)
```

Let $\gamma_{x, x'} \in [0, 1]$ be the probability that a person on ART residing in district $x$ receives ART in district $x'$.
We assume that $\gamma_{x, x'} = 0$ for $x \notin \{x, \text{ne}(x)\}$ such that individuals seek treatment only in their residing district or its neighbours $\text{ne}(x) = \{x': x' \sim x\}$, where $\sim$ is an adjacency relation, and $\sum_{x' \in \{x, \text{ne}(x)\}} \gamma_{x, x'} = 1$.
To model $\gamma_{x, x'}$ for $x \sim x'$ we use a multinomial logistic regression model, based on the log-odds ratios
\begin{equation}
\tilde \gamma_{x, x'} = \log \left( \frac{\gamma_{x, x'}}{1 - \gamma_{x, x'}} \right) = \tilde \gamma_0 + u_x^{\tilde \gamma}, \label{eq:log-or}
\end{equation}
where $\tilde \gamma_0 = -4$ is a fixed intercept, and $u_x^{\tilde \gamma} \sim \mathcal{N}(0, \sigma_X^{\tilde \gamma})$ are district random effects with $\sigma_X^{\tilde \gamma} \sim \mathcal{N}^+(0, 2.5)$.
Note that Equation \ref{eq:log-or} does not depend on $x'$, such that $\gamma_{x, x'}$ is only a function of $x$.
Choice of $\tilde \gamma_0 = -4$ implies a prior mean on $\gamma_{x, x'}$ of 1.8%, such that $(100 - 1.8 \times \text{ne}(x))\%$ of ART clients in district $x$ obtain treatment in their home district, a-priori.
We fix $\tilde \gamma_{x, x} = 0$ and recover the multinomial probabilities using the softmax
$$
\gamma_{x, x'} = \frac{\exp(\tilde \gamma_{x, x'})}{\sum_{x^\star \in \{x, \text{ne}(x)\}} \exp(\tilde \gamma_{x, x^\star})}.
$$
Given the total number of PLHIV on ART $A_{x, s, a} = N_{x, s, a} \cdot \rho_{x, s, a} \cdot \alpha_{x, s, a}$, the number of ART clients who reside in district $x$ and obtain ART in district $x'$ are $A_{x, x', s, a} = A_{x, s, a} \cdot \gamma_{x, x'}$, and the total attending ART facilities in district $x'$ are 
$$
\tilde A_{x', s, a} = \sum_{x \in \{x', \text{ne}(x')\}} A_{x, x', s, a}.
$$

## Likelihood specification \label{sec:likelihood}

### Household survey data

For HIV prevalence, ART coverage and recent HIV infections, denoted by $\theta \in \{\rho, \alpha, \kappa\}$, the most recent household survey furnishes weighted observations $\hat \theta_{\{x\}, \{s\}, \{a\}}$ with respective Kish effective sample sizes $m^{\hat \theta}_{\{x\}, \{s\}, \{a\}} \in \mathbb{R}$, and observed number of cases
$$
y^{\hat \theta}_{\{x\}, \{s\}, \{a\}} = m^{\hat \theta}_{\{x\}, \{s\}, \{a\}} \cdot \hat \theta_{\{x\}, \{s\}, \{a\}} \in \mathbb{R}.
$$
To model these observations, we use following three binomial working likelihoods
\begin{align*}
y^{\hat \rho}_{\{x\}, \{s\}, \{a\}} &\sim \text{xBin}(m^{\hat \rho}_{\{x\}, \{s\}, \{a\}}, \rho_{\{x\}, \{s\}, \{a\}}), \quad
\rho_{\{x\}, \{s\}, \{a\}} = \frac{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a}}{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a}}, \\
y^{\hat \alpha}_{\{x\}, \{s\}, \{a\}} &\sim \text{xBin}(m^{\hat \alpha}_{\{x\}, \{s\}, \{a\}}, \alpha_{\{x\}, \{s\}, \{a\}}), \quad
\alpha_{\{x\}, \{s\}, \{a\}} = \frac{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a} \cdot \alpha_{x, s, a}}{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a}}, \\
y^{\hat \kappa}_{\{x\}, \{s\}, \{a\}} &\sim \text{xBin}(m^{\hat \kappa}_{\{x\}, \{s\}, \{a\}}, \kappa_{\{x\}, \{s\}, \{a\}}), \quad
\kappa_{\{x\}, \{s\}, \{a\}} = \frac{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a} \cdot \kappa_{x, s, a}}{\sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} N_{x, s, a} \cdot \rho_{x, s, a}}.
\end{align*}
The generalised binomial $y \sim \text{xBin}(m, p)$ is defined for $y, m \in \mathbb{R}^+$ with $y \leq m$ such that
$$
\log p(y) = \log \Gamma(m + 1) - \log \Gamma(y + 1) - \log \Gamma(m - y + 1) + y \log p + (m - y) \log(1 - p),
$$
where the gamma function $\Gamma$ is such that $\forall n \in \mathbb{N}$, $\Gamma(n) = (n - 1)!$.

### ANC testing data

We include ANC testing data for the year of the most recent survey.
Let $W^\text{ANC}_{\{x\}}$ be the number of ANC clients, $X^\text{ANC}_{\{x\}}$ the number of those with ascertained status, $Y^\text{ANC}_{\{x\}}$ the number of those with positive status (either known or tested) and $Z^\text{ANC}_{\{x\}}$ the number of ANC clients already on ART prior to first ANC, such that
$$
W^\text{ANC}_{x} \geq X^\text{ANC}_{x} \geq Y^\text{ANC}_{x} \geq Z^\text{ANC}_{x},
$$
for all $x \in \{x\}$.
When ANC testing data are only available for part of a given year, we denote $m^\text{ANC} \in \{1, \ldots, 12\}$ the number of months of reported data reflected in counts for that year.
The observed number of HIV positive and already on ART among ANC clients is modelled by
\begin{align*}
Y_{\{x\} }^{\text{ANC}} &\sim \text{Bin} \left(X_{\{x\} }^{\text{ANC}}, \rho_{\{x\},\{15, \ldots 45\}}^{\text{ANC}}\right), \\
Z_{\{x\} }^{\text{ANC}} &\sim \text{Bin} \left(Y_{\{x\} }^{\text{ANC}}, \alpha_{\{x\},\{15, \ldots 45\}}^{\text{ANC}}\right),
\end{align*}
where prevalence and ART coverage are aggregated by the number of pregnant women $\Psi_{x, a}$
\begin{align*}
\rho_{\{x\}\{a\}}^{\text{ANC}} &= \frac{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a} \cdot \rho_{x, a}^{\text{ANC}}}{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a}}, \\
\alpha_{\{x\}\{a\}}^{\text{ANC}} &= \frac{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a} \cdot \rho_{x, a}^{\text{ANC}} \cdot \alpha_{x, a}^{\text{ANC}}}{\sum_{\{x\}} \sum_{\{a\}} \Psi_{x, a} \cdot \rho_{x, a}^{\text{ANC}}}.
\end{align*}

### Number receiving ART

Let $\dot A_{\{x\}, \{s\}, \{a\}}$ be data for the number receiving ART
$$
\dot A_{\{x\}, \{s\}, \{a\}} = \sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} \sum_{x \sim x', x = x'} \dot A_{x', x, s, a}.
$$
We model the unobserved numbers of ART clients travelling from $x'$ to $x$ as
$$
\dot A_{x', x, s, a} \sim \text{Bin}(N_{x', s, a}, \pi_{x', x, s, a})
$$
where $\pi_{x', x, s, a} = \rho_{x', s, a} \cdot \alpha_{x', s, a} \cdot \gamma_{x', x, s, a}$. This likelihood is approximated using a normal for the sum of binomials by
$$
\dot A_{\{x\}, \{s\}, \{a\}} \sim \mathcal{N}(\tilde A_{\{x\}, \{s\}, \{a\}}, \sigma^{\tilde A}_{\{x\}, \{s\}, \{a\}})
$$
where the mean is
$$
\tilde{A}_{\{x\},\{s\}\{a\}} = \sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} \sum_{x \sim x', x = x'} N_{x', s, a} \cdot \pi_{x', x, s, a},
$$
and the variance is
$$
\left(\sigma_{\{x\},\{s\}\{a\}}^{\tilde{A}}\right)^2 = \sum_{\{x\}} \sum_{\{s\}} \sum_{\{a\}} \sum_{x \sim x', x = x'} N_{x', s, a} \cdot \pi_{x', x, s, a} \cdot \left(1-\pi_{x', x, s, a}\right).
$$

## Identifiability constaints

If data are missing, some parameters are fixed to default values to help with identifiability.
In particular:

1. If survey data on HIV prevalence or ART coverage by age and sex are not available then we set $u_a^\theta = 0$ and $u_{a, s = \text{M}}^\theta = 0$ and use the average age-sex pattern of from the Spectrum offset $\eta_{R_x, s, a}^\theta$. For the Malawi example considered in the main text HIV prevalence and ART coverage data are not available for those aged 65+. As a result, there are $|\{\text{0-4}, \ldots, \text{50-54}\}| = 13$ age groups included for the age random effects.
2. If no ART data, either survey or ART programme, are available but data on ART coverage among ANC clients are available, the level of ART coverage is not identifiable, but spatial variation is identifiable. In this instance, overall ART coverage is determined by the Spectrum offset, and only area random effects are estimated such that $\text{logit} \left(\alpha_{x, s, a} \right) = u_x^\alpha + \eta_{R_x, s, a}^\alpha$.
3. If survey data on recent HIV infection are not included in the model, then $\beta_0^\lambda = \beta_S^{\lambda, s = \text{M}} = u_x^\lambda = 0$. The sex ratio for HIV incidence is determined by the sex incidence rate ratio from Spectrum in the same years and the incidence rate in all districts is modelled assuming the same average HIV transmission rate for untreated adults, but varies according to district estimates of HIV prevalence and ART coverage.

```{r simplified-naomi, fig.cap="Directed acyclic graph describing the simplified Naomi model (work in progress)."}
knitr::include_graphics("depends/simplified-naomi.pdf")
```

\newpage

# \textsc{C++} `TMB` user template

<!-- Use table(names(tmb$fit$par.full)) to check the below table -->

```{=tex}
\begin{table}[p!]
\centering
\begin{tabularx}{\textwidth}{llllllll}
\toprule
Variable name & Notation & Type & Size & Domain & $\rho$ input? & $\alpha$ input? & $\lambda$ input? \\
\midrule
\texttt{logit\_phi\_rho\_x} & $\text{logit}(\phi_X^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_x} & $\log(\sigma_X^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_rho\_xs} & $\text{logit}(\phi_{XS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_xs} & $\log(\sigma_{XS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_rho\_a} & $\text{logit}(\phi_A^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_a} & $\log(\sigma_A^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_rho\_as} & $\text{logit}(\phi_{AS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_as} & $\log(\sigma_{AS}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{log\_sigma\_rho\_xa} & $\log(\sigma_{XA}^\rho)$ & Hyper & 1 & $\mathbb{R}$ & \cmark & & \\
\texttt{logit\_phi\_alpha\_x} & $\text{logit}(\phi_X^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_x} & $\log(\sigma_X^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{logit\_phi\_alpha\_xs} & $\text{logit}(\phi_{XS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_xs} & $\log(\sigma_{XS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{logit\_phi\_alpha\_a} & $\text{logit}(\phi_A^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_a} & $\log(\sigma_A^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{logit\_phi\_alpha\_as} & $\text{logit}(\phi_{AS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_as} & $\log(\sigma_{AS}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{log\_sigma\_alpha\_xa} & $\log(\sigma_{XA}^\alpha)$ & Hyper & 1 & $\mathbb{R}$ & & \cmark & \\
\texttt{OmegaT\_raw} & $\Omega_T$ & Hyper & 1 & $\mathbb{R}$ & & & \cmark \\
\texttt{log\_betaT} & $\log(\beta_T)$ & Hyper & 1 & $\mathbb{R}$ & & & \cmark \\
\texttt{log\_sigma\_lambda\_x} & $\log(\sigma^\lambda)$ & Hyper & 1 & $\mathbb{R}$ & & & \cmark \\
\texttt{log\_sigma\_ancrho\_x} & $\log(\sigma_X^{\rho^{\text{ANC}}})$ & Hyper & 1 & $\mathbb{R}$ & & & \\
\texttt{log\_sigma\_ancalpha\_x} & $\log(\sigma_X^{\alpha^{\text{ANC}}})$ & Hyper & 1 & $\mathbb{R}$ & & & \\
\texttt{log\_sigma\_or\_gamma} & $\log(\sigma_X^{\tilde \gamma})$ & Hyper & 1 & $\mathbb{R}$ & & & \\
\texttt{beta\_rho} & $(\beta^\rho_0, \beta_{s}^{\rho, s = \text{M}})$ & Latent & 2 & $\mathbb{R}^2$ & \cmark & & \\
\texttt{beta\_alpha} & $(\beta^\alpha_0, \beta_{S}^{\alpha, s = \text{M}})$ & Latent & 2 & $\mathbb{R}^2$ & & \cmark & \\
\texttt{beta\_lambda} & $(\beta_0^\lambda, \beta_S^{\lambda, s = \text{M}})$ & Latent & 2 & $\mathbb{R}^2$ & & & \cmark \\
\texttt{beta\_anc\_rho} & $\beta^{\rho^{\text{ANC}}}$ & Latent & 1 & $\mathbb{R}$ & & & \\
\texttt{beta\_anc\_alpha} & $\beta^{\alpha^{\text{ANC}}}$ & Latent & 1 & $\mathbb{R}$ & & & \\
\texttt{u\_rho\_x} & $w^\rho_x$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{us\_rho\_x} & $v^\rho_x$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{u\_rho\_xs} & $w_x^{\rho, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{us\_rho\_xs} & $v_x^{\rho, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{u\_rho\_a} & $u^\rho_a$ & Latent & 10 & $\mathbb{R}^{10}$ & \cmark & & \\
\texttt{u\_rho\_as} & $u_a^{\rho, s = \text{M}}$ & Latent & 10 & $\mathbb{R}^{10}$ & \cmark & & \\
\texttt{u\_rho\_xa} & $u_x^{\rho, a < 15}$ & Latent & $n$ & $\mathbb{R}^{n}$ & \cmark & & \\
\texttt{u\_alpha\_x} & $w^\alpha_x$ & Latent & $n$ & $\mathbb{R}^{n}$ && \cmark & \\
\texttt{us\_alpha\_x} & $v^\alpha_x$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{u\_alpha\_xs} & $w_x^{\alpha, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{us\_alpha\_xs} & $v_x^{\alpha, s = \text{M}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{u\_alpha\_a} & $u^\alpha_a$ & Latent & 13 & $\mathbb{R}^{13}$ & & \cmark & \\
\texttt{u\_alpha\_as} & $u_a^{\alpha, s = \text{M}}$ & Latent & 10 & $\mathbb{R}^{10}$ & & \cmark & \\
\texttt{u\_alpha\_xa} & $u_x^{\alpha, a < 15}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & \cmark & \\
\texttt{ui\_lambda\_x} & $u_x^\lambda$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \cmark \\
\texttt{ui\_anc\_rho\_x} & $u_x^{\rho^{\text{ANC}}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \\
\texttt{ui\_anc\_alpha\_x} & $u_x^{\alpha^{\text{ANC}}}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \\
\texttt{log\_or\_gamma} & $u_x^{\tilde \gamma}$ & Latent & $n$ & $\mathbb{R}^{n}$ & & & \\
\bottomrule
\end{tabularx}
\label{tab:tmb-lookup}
\caption{Correspondence between mathematical notation and variable names used in our \texttt{TMB} code. The total number of hyperparameters is 24, and the total number of latent field parameters is $51 + 14n$, where $n$ is the number of districts. We use the notation \cmark \ to refer to direct dependence of the parameter on the variable, \xmark \ to refer to no dependence, and a blank entry to refer to dependence conditional on the data.}
\end{table}
```

<!-- Latent field size -->
<!-- 2 + 2 + 2 + 1 + 1+ 10 + 10 + 13 + 10 + 14n = 51 + 14n -->
<!-- Hyperparameter size -->
<!-- 24 -->

This section contains C++ `TMB` code for the negative log-posterior of the simplified Naomi model
For ease of understanding, Table \ref{tab:tmb-lookup} provides correspondence between the mathematical notation used in Section \ref{sec:math} and the variable names used in the `TMB` code, for all hyperparameters and latent field parameters.
For further reference on the `TMB` software see `https://kaskr.github.io/adcomp/_book`, or on the method see @kristensen2016tmb.

\newpage

```{cpp, echo=TRUE, eval=FALSE, output.var="ex", code=readLines("naomi_simple.cpp")}
```

\newpage

# MCMC convergence and suitability

We assessed MCMC convergence and suitability using a range of graphical and numerical tests. These included the potential scale reduction factor $\hat R$, bulk and tail effective sample size (ESS), autocorrelation decay plots, univariate traceplots, pairs density plots, and NUTS specific divergent transition and energy assessments.

For the time being, this analysis is available from `athowes.github.io/elgm-inf/mcmc-convergence`.
Once the MCMC results are finalised, the analysis will be moved to this appendix and expanded upon.
The following draft text and references may be useful in that expanded write-up.

- Improved $\hat R$ statistic from @vehtari2021rank. Recommended only to use the sample if the value is less than 1.05.
- ESS and autocorrelation related to efficiency
- Traceplots helpful for diagnosis of problems
- Pairs density plots helpful for understanding relationships between parameters, including possible identifiability issues
- Energy plot from @betancourt2017conceptual

\newpage

# Laplace marginals algorithm

1. Calculate the mode, Hessian at the mode, and lower Cholesky
\begin{align*}
\hat{\btheta} &= \argmax_{\btheta} {\tilde p_\texttt{LA}(\btheta, \y)}, \\
\mathbf{H} &= - \frac{\partial^2}{\partial \btheta \partial \btheta^\top} \log \tilde p_\texttt{LA}(\btheta, \y) \rvert_{\btheta = \hat \btheta} \\
\mathbf{H}^{-1} &= \mathbf{L} \mathbf{L}^\top,
\end{align*}
of the Laplace approximation
$$
\tilde p_\texttt{LA}(\btheta, \y) = \frac{p(\y, \x, \btheta)}{\tilde p_\texttt{G}(\x \, | \, \btheta, \y)} \Big\rvert_{\x = \hat \x(\btheta)}
$$
where $\tilde p_\texttt{G}(\x \, | \, \btheta, \y) = \mathcal{N}(\x \, | \, \hat \x(\btheta), \mathbf{H}(\btheta)^{-1})$ is a Gaussian approximation to $p(\x \, | \, \btheta, \y)$ with mode and precision matrix given by
\begin{align*}
\hat \x(\btheta) &= \argmax_\x \log p(\y, \x, \btheta), \\
\mathbf{H}(\btheta) &= - \frac{\partial^2}{\partial x \partial x^\top} \log p(\y, \x, \btheta) \rvert_{\x = \hat \x(\btheta)}.
\end{align*}
2. Generate a set of nodes $\bu \in \mathcal{Q}(m, k)$ and weights $\omega: \bu \to \mathbb{R}$ from a Gauss-Hermite quadrature rule with $k$ nodes per dimension, which are then adapted based on the mode and lower Choleksy via $\btheta(\bu) = \hat{\btheta} + \mathbf{L} \bu$.
If possible $k \geq 3$ is preferred, though the number of grid points scales exponentially with choice of $k$.
Then, use this quadrature rule to calculate the normalising constant $\tilde p_{\texttt{AQ}}(\y)$ as follows
\begin{equation}
\tilde p_{\texttt{AQ}}(\y) = \sum_{\bu \in \mathcal{Q}(m, k)} \tilde p_\texttt{LA}(\btheta(\bu), \y) \omega(\bu). \label{eq:evidence1}
\end{equation}
4. For $i \in [n]$ generate $l$ nodes $x_i(\bv)$ via a Gauss-Hermite quadrature rule $\bv \in \mathcal{Q}(1, l)$ adapted based on the mode $\hat \x(\btheta)_i$ and standard deviation $\sqrt{\text{diag}[\mathbf{H}(\btheta)^{-1}]_i}$ of the Gaussian marginal. A value of $l \geq 4$ is recommended to enable B-spline interpolation.
Then, for $x_i \in \{ x_i(\bv) \}_{\bv \in \mathcal{Q}(1, l)}$  and $\btheta \in \{ \btheta(\bu) \}_{\bu \in \mathcal{Q}(m, k)}$ calculate the modes and Hessians
\begin{align*}
\hat \x_{-i}(x_i, \btheta) &= \argmax_{\x_{-i}} \log p(\y, x_i, \x_{-i}, \btheta), \\
\mathbf{H}_{-i, -i}(x_i, \btheta) &= - \frac{\partial^2}{\partial \x_{-i} \partial \x_{-i}^\top} \log p(\y, x_i, \x_{-i}, \btheta) \rvert_{\x_{-i} = \hat \x_{-i}(x_i, \btheta)},
\end{align*}
where optimisation to obtain $\hat \x_{-i}(x_i, \btheta)$ is initialised at $\hat \x(\btheta)_{-i}$.
6. For $x_i \in \{ x_i(\bv) \}_{\bv \in \mathcal{Q}(1, l)}$ calculate
\begin{equation}
\tilde p_\texttt{AQ}(x_i \, | \, \y) = \frac{\tilde p_\texttt{LA}(x_i, \y)}{\tilde p_{\texttt{AQ}}(\y)}. \label{eq:laplace-marginal}
\end{equation}
where
$$
\tilde p_\texttt{LA}(x_i, \y) = \sum_{\bu \in \mathcal{Q}(m, k)} \tilde p_\texttt{LA}(x_i, \btheta(\bu), \y) \omega(\bu).
$$
and
$$
\tilde p_\texttt{LA}(x_i, \btheta, \y) = \frac{p(x_i, \x_{-i}, \btheta, \y)}{\tilde p_\texttt{G}(\x_{-i} \, | \, x_i, \btheta, \y)} \Big\rvert_{\x_{-i} = \hat \x_{-i}(x_i, \btheta)}.
$$
Although Equation \ref{eq:laplace-marginal} can be calculated using the estimate of the evidence in Equation \ref{eq:evidence1} it is more numerically accurate to use the estimate
$$
\tilde p_{\texttt{AQ}}(\y) = \sum_{\bv \in \mathcal{Q}(1, l)} \tilde p_\texttt{LA}(x_i(\bv), \y) \omega(\bv)
$$

7. Given $\{x_i(\bv), \tilde p_\texttt{AQ}(x_i(\bv) \, | \, \y)\}_{\bv \in \mathcal{Q}(1, l)}$ create a spline interpolant to each posterior marginal on the log-scale. Samples, and thereby relevant posterior marginal summaries, may be obtained using inverse transform sampling.

```{r algorithm-flowchart, fig.cap="Flowchart describing the algorithm we propose (work in progress)."}
knitr::include_graphics("depends/algorithm-flowchart.pdf")
```

\newpage

# References {#references .unnumbered}
