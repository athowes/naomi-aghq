---
title: "Fast approximate Bayesian inference of HIV indicators"
author: "Adam Howes"
date: "April 2023"
output:
  beamer_presentation:
    latex_engine: pdflatex
    highlight: haddock
    fig_width: 7
    fig_height: 3
    includes:
      in_header: preamble.tex
subtitle: PhD Student Presentations & Networking Event
bibliography: citations.bib
institute: Imperial College London
---

# 

```{r, echo=FALSE, fig.cap="Estimates of HIV indicators at a district level produced using the Naomi model.", out.width = '90%'}
knitr::include_graphics("depends/naomi_results.png")
```

# 

```{r, echo=FALSE, fig.cap="Example of the user interface from \\texttt{https://naomi.unaids.org/}", out.width = '70%'}
knitr::include_graphics("naomi_user.png")
```

# Goal

* Fast approximate Bayesian inference for a complex, spatiotemporal, evidence synthesis model

# Approach

1. The marginal Laplace approximation
2. Adaptive Gauss-Hermite quadrature
3. Principle components analysis

# The marginal Laplace approximation

#

```{r, echo=FALSE, message=FALSE, fig.cap="Unadapted Gauss-Hermite points in two dimensions with $k = 3$."}
mu <- c(1, 1.5)
cov <- matrix(c(2, 1, 1, 1), ncol = 2)

obj <- function(theta) {
  mvtnorm::dmvnorm(theta, mean = mu, sigma = cov)
}

grid <- expand.grid(
  theta1 = seq(-2, 5, length.out = 700),
  theta2 = seq(-2, 5, length.out = 700)
)

ground_truth <- cbind(grid, pdf = obj(grid))

plot0 <- ggplot(ground_truth, aes(x = theta1, y = theta2, z = pdf)) +
  geom_contour(col = cbpalette[1]) +
  coord_fixed(xlim = c(-2, 4.5), ylim = c(-2, 4.5), ratio = 1) +
  labs(x = "", y = "") +
  theme_minimal()

gg <- mvQuad::createNIGrid(2, "GHe", 3)

add_points <- function(plot0, gg) {
  plot0 +
    geom_point(
      data = mvQuad::getNodes(gg) %>%
              as.data.frame() %>%
              mutate(weights = mvQuad::getWeights(gg)),
      aes(x = V1, y = V2, size = weights),
      alpha = 0.8,
      col = cbpalette[2],
      inherit.aes = FALSE
    ) +
    scale_size_continuous(range = c(1, 2))
}

add_points(plot0, gg) +
  labs(size = "Weight", caption = "")
```

#

```{r, echo=FALSE, message=FALSE, fig.cap="Add the mean $z + \\hat \\theta$."}
gg2 <- gg
mvQuad::rescale(gg2, m = mu, C = diag(c(1, 1)), dec.type = 2)

add_points(plot0, gg2) +
  labs(size = "Weight", caption = "")
```

#

```{r, echo=FALSE, message=FALSE, fig.cap="First option: rotate by the lower Cholesky $Lz + \\hat \\theta$."}
gg3 <- gg
mvQuad::rescale(gg3, m = mu, C = cov, dec.type = 2)

add_points(plot0, gg3) +
  labs(size = "Weight", caption = "")
```

#

```{r, echo=FALSE, message=FALSE, fig.cap="Second option: rotate using the eigendecomposition $E \\Lambda^{1/2} z + \\hat \\theta$."}
gg3 <- gg
mvQuad::rescale(gg3, m = mu, C = cov, dec.type = 1)

add_points(plot0, gg3) +
  labs(size = "Weight", caption = "")
```

#

```{r, echo=FALSE, message=FALSE, fig.cap="Now keeping only the first principal component, $s = 1$."}
gg4 <- mvQuad::createNIGrid(2, "GHe", level = c(3, 1))
mvQuad::rescale(gg4, m = mu, C = cov, dec.type = 1)

add_points(plot0, gg4) +
  labs(size = "Weight", caption = "")
```

#

```{r, echo=FALSE, fig.cap="Scree plot suggests 10 or so dimensions is enough. We use $s = 8$ to avoid long computation times.", out.width = '80%'}
knitr::include_graphics("depends/tv-plot.png")
```

#

```{r, echo=FALSE, fig.cap="With 8 dimenions, the covariance matrix is accurately reproduced.", out.width = '80%'}
knitr::include_graphics("depends/reduced-rank-plot.png")
```

# Thanks for listening!

```{r echo=FALSE, out.width = "300px", fig.align='center'}
knitr::include_graphics("mrc-gida-icl-mlgh.png")
```

# References {.allowframebreaks}
