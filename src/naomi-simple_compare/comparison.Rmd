---
title: "Inference methods comparison for the simplified Naomi model"
author:
- name: Adam Howes
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    df_print: paged
    code_folding: show
    theme: lumen
abstract: |
  **Background**  We have run the simplified Naomi model using a range of inference methods.
  
  **Task** In this report, we compare the accuracy of the posterior distributions obtained from these inference methods.
---

# Background

We compare the inference results from `TMB`, `aghq`, `adam`, and `tmbstan`.
Import these inference results as follows:

```{r}
tmb <- readRDS("depends/tmb.rds")
aghq <- readRDS("depends/aghq.rds")
adam <- readRDS("depends/adam.rds")
tmbstan <- readRDS("depends/tmbstan.rds")
```

For more information about the conditions under which these results were generated, see:

```{r}
depends <- yaml::read_yaml("orderly.yml")$depends

for(i in seq_along(depends)) {
  report_name <- names(depends[[i]])
  print(paste0("Inference results obtained from ", report_name, " with the query ", depends[[i]][[report_name]]$id))
  report_id <- orderly::orderly_search(query = depends[[i]][[report_name]]$id, report_name)
  print(paste0("Obtained report had ID ", report_id, " and was run with the following parameters:"))
  print(orderly::orderly_info(report_id, report_name)$parameters)
}
```

All of the possible parameter names are as follows:

```{r}
pars <- unique(names(tmb$fit$obj$env$par))
```

# Time taken

```{r}
data.frame(
  "TMB" = tmb$time,
  "aghq" = aghq$time,
  "adam" = adam$time,
  "tmbstan" = tmbstan$time
)

adam <- adam$adam
```

# Histograms {.tabset .tabset-fade}

```{r}
beta_rho <- histogram_and_ecdf("beta_rho", i = 1, return_df = TRUE)
saveRDS(beta_rho$df, "beta_rho.rds")
```

## `beta_rho`

```{r}
histogram_and_ecdf_helper <- function(par) lapply(1:sum(names(tmb$fit$obj$env$par) == par), histogram_and_ecdf, par = par)
histogram_and_ecdf_helper("beta_rho")
```

## `beta_alpha`

```{r}
histogram_and_ecdf_helper("beta_alpha")
```

## `beta_lambda`

```{r}
histogram_and_ecdf_helper("beta_lambda")
```

## `beta_anc_rho`

```{r}
histogram_and_ecdf("beta_anc_rho")
```

## `beta_anc_alpha`

```{r}
histogram_and_ecdf("beta_anc_alpha")
```

## `logit`

```{r}
lapply(pars[stringr::str_starts(pars, "logit")], histogram_and_ecdf)
```

## `log_sigma`

```{r}
lapply(pars[stringr::str_starts(pars, "log_sigma")], histogram_and_ecdf)
```

## `u_rho_x`

```{r}
histogram_and_ecdf_helper("u_rho_x")
```

## `u_rho_x`

```{r}
histogram_and_ecdf_helper("u_rho_x")
```

## `us_rho_x`

```{r}
histogram_and_ecdf_helper("us_rho_x")
```

## `u_rho_xs`

```{r}
histogram_and_ecdf_helper("u_rho_xs")
```

## `us_rho_xs`

```{r}
histogram_and_ecdf_helper("us_rho_xs")
```

## `u_rho_as`

```{r}
histogram_and_ecdf_helper("u_rho_as")
```

## `u_alpha_x`

```{r}
histogram_and_ecdf_helper("u_alpha_x")
```

## `us_alpha_x`

```{r}
histogram_and_ecdf_helper("us_alpha_x")
```

## `u_alpha_xs`

```{r}
histogram_and_ecdf_helper("u_alpha_xs")
```

## `us_alpha_xs`

```{r}
histogram_and_ecdf_helper("us_alpha_xs")
```

## `u_alpha_a`

```{r}
histogram_and_ecdf_helper("u_alpha_a")
```

## `u_alpha_as`

```{r}
histogram_and_ecdf_helper("u_alpha_as")
```

## `u_alpha_xa`

```{r}
histogram_and_ecdf_helper("u_alpha_xa")
```

## `ui_lambda_x`

```{r}
histogram_and_ecdf_helper("ui_lambda_x")
```

## `ui_anc_rho_x`

```{r}
histogram_and_ecdf_helper("ui_anc_rho_x")
```

## `ui_anc_alpha_x`

```{r}
histogram_and_ecdf_helper("ui_anc_alpha_x")
```

## `log_or_gamma`

```{r}
histogram_and_ecdf_helper("log_or_gamma")
```

# KS plots 

## Individual parameters {.tabset .tabset-fade}

```{r}
ks_helper <- function(par, ...) {
  to_ks_df(par) %>% ks_plot(par, ...)
}
```

### `beta`

```{r}
ks_helper("beta")
ks_helper("beta", method1 = "TMB", method2 = "adam")
```

### `logit`

```{r}
ks_helper("logit")
ks_helper("logit", method1 = "TMB", method2 = "adam")
```

### `log_sigma`

```{r}
ks_helper("log_sigma")
ks_helper("log_sigma", method1 = "TMB", method2 = "adam")
```

### `u_rho_x`

```{r}
ks_helper("u_rho_x")
ks_helper("u_rho_x", method1 = "TMB", method2 = "adam")
```

### `u_rho_xs`

```{r}
ks_helper("u_rho_xs")
ks_helper("u_rho_xs", method1 = "TMB", method2 = "adam")
```

### `us_rho_x`

```{r}
ks_helper("us_rho_x")
ks_helper("us_rho_x", method1 = "TMB", method2 = "adam")
```

### `us_rho_xs`

```{r}
ks_helper("us_rho_xs")
ks_helper("us_rho_xs", method1 = "TMB", method2 = "adam")
```

### `u_rho_a`

```{r}
ks_helper("u_rho_a")
ks_helper("u_rho_a", method1 = "TMB", method2 = "adam")
```

### `u_rho_as`

```{r}
ks_helper("u_rho_as")
ks_helper("u_rho_as", method1 = "TMB", method2 = "adam")
```

### `u_alpha_x`

```{r}
ks_helper("u_alpha_x")
ks_helper("u_alpha_x", method1 = "TMB", method2 = "adam")
```

### `u_alpha_xs`

```{r}
ks_helper("u_alpha_xs")
ks_helper("u_alpha_xs", method1 = "TMB", method2 = "adam")
```

### `us_alpha_x`

```{r}
ks_helper("us_alpha_x")
ks_helper("us_alpha_x", method1 = "TMB", method2 = "adam")
```

### `us_alpha_xs`

```{r}
ks_helper("us_alpha_xs")
ks_helper("us_alpha_xs", method1 = "TMB", method2 = "adam")
```

### `u_alpha_a`

```{r}
ks_helper("u_alpha_a")
ks_helper("u_alpha_a", method1 = "TMB", method2 = "adam")
```

### `u_alpha_as`

```{r}
ks_helper("u_alpha_as")
ks_helper("u_alpha_as", method1 = "TMB", method2 = "adam")
```

### `u_alpha_xa`

```{r}
ks_helper("u_alpha_xa")
ks_helper("u_alpha_xa", method1 = "TMB", method2 = "adam")
```

### `ui_anc_rho_x`

```{r}
ks_helper("ui_anc_rho_x")
ks_helper("ui_anc_rho_x", method1 = "TMB", method2 = "adam")
```

### `ui_anc_alpha_x`

```{r}
ks_helper("ui_anc_alpha_x")
ks_helper("ui_anc_alpha_x", method1 = "TMB", method2 = "adam")
```

### `log_or_gamma`

```{r}
ks_helper("log_or_gamma")
ks_helper("log_or_gamma", method1 = "TMB", method2 = "adam")
```

## Summary table

```{r}
ks_summary <- lapply(unique(names(tmb$fit$obj$env$par)), function(x) {
  to_ks_df(x) %>%
    group_by(method) %>%
    summarise(ks = mean(ks), par = x)
}) %>%
  bind_rows() %>%
  pivot_wider(names_from = "method", values_from = "ks") %>%
  rename(
    "Parameter" = "par",
    "KS(adam, tmbstan)" = "adam",
    "KS(aghq, tmbstan)" = "aghq",
    "KS(TMB, tmbstan)" = "TMB",
  )

ks_summary %>%
  gt::gt() %>%
  gt::fmt_number(
    columns = starts_with("KS"),
    decimals = 3
  )

r <- adam$quad$obj$env$random
x_names <- names(adam$quad$obj$env$par[r])
theta_names <- names(adam$quad$obj$env$par[-r])

dict <- data.frame(
  Parameter = c(x_names, theta_names),
  Type = c(rep("Latent field", length(x_names)), rep("Hyperparameters", length(theta_names)))
)

ks_summary <- ks_summary %>%
  left_join(dict, by = "Parameter")

summary_ks_plot <- function(ks_summary, method1, method2) {
  ks_method1 <- paste0("KS(", method1, ", tmbstan)")
  ks_method2 <- paste0("KS(", method2, ", tmbstan)")
  
  scatterplot <- ggplot(ks_summary, aes(x = .data[[ks_method1]], y = .data[[ks_method2]])) +
    geom_point(alpha = 0.2) +
    annotate(geom = "polygon", x = c(-Inf, Inf, Inf), y = c(-Inf, Inf, -Inf), fill = multi.utils::cbpalette()[3], alpha = 0.1) +
    annotate(geom = "polygon", x = c(-Inf, Inf, -Inf), y = c(-Inf, Inf, Inf), fill = multi.utils::cbpalette()[5], alpha = 0.1) +
    xlim(0, 1) +
    ylim(0, 1) +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
    labs(x = ks_method1, y = ks_method2) +
    theme_minimal() 

  ks_summary[["KS difference"]] <- ks_summary[[ks_method1]] - ks_summary[[ks_method2]]
  
  jitterplot <- ggplot(ks_summary, aes(x = Type, y = `KS difference`)) +
    geom_jitter(width = 0.1, alpha = 0.2) +
    labs(x = "", y = paste0(ks_method1, " - ", ks_method2)) +
    theme_minimal()

  scatterplot + jitterplot
}

summary_ks_plot(ks_summary, "TMB", "aghq")
summary_ks_plot(ks_summary, "TMB", "adam")
summary_ks_plot(ks_summary, "aghq", "adam")

(ks_summary_out <- ks_summary %>%
  group_by(Type) %>%
  summarise(
    TMB = mean(`KS(TMB, tmbstan)`),
    aghq = mean(`KS(aghq, tmbstan)`),
    adam = mean(`KS(adam, tmbstan)`)
  ))
```

Save some things for output:

```{r}
pdf("ks_summary_tmb_adam.pdf", h = 4, w = 6.25)
summary_ks_plot(ks_summary, "TMB", "adam")
dev.off()

saveRDS(ks_summary_out, "ks_summary_out.rds")
```

## Investigation into large KS values

The following parameters have KS values greater than 0.5 in both dimensions.

```{r}
(big_ks <- ks_summary %>%
  filter(`KS(aghq, tmbstan)` + `KS(TMB, tmbstan)` > 0.5) %>%
  pull(Parameter))
```

# MMD

```{r}
#' To write!
```

# PSIS

Suppose we have two sets of samples from the posterior.
For each sample we are going to want to evaluate the log-likelihood, so that we can calculate the log-likelihood ratios.
We can extract the `TMB` objective function for the log-likelihood as follows:

```{r}
tmb$fit$obj$fn()
```
