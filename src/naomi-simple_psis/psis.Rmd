---
title: "Inference methods comparison for the simplified Naomi model using Pareto-smoothed importance sampling"
author:
- name: Adam Howes
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    df_print: paged
    code_folding: show
    theme: lumen
abstract: |
  **Background**  We have run the simplified Naomi model using a range of inference methods: `TMB`, `aghq`, `adam` and `tmbstan`.
  
  **Task** In this report, we compare the accuracy of the posterior distributions obtained from these inference methods using Pareto-smoothed importance sampling.
---

# Background

We compare the inference results from `TMB`, `aghq`, `adam`, and `tmbstan`.
Import these inference results as follows:

```{r}
tmb <- readRDS("depends/tmb.rds")
aghq <- readRDS("depends/aghq.rds")
tmbstan <- readRDS("depends/tmbstan.rds")

depends <- yaml::read_yaml("orderly.yml")$depends
```

Check that the parameters (latent field, hyperparameters, model outputs) sampled from each of the four methods are the same:

```{r}
stopifnot(names(tmb$fit$sample) == names(aghq$quad$sample))
stopifnot(names(tmb$fit$sample) == names(adam$adam$sample))
stopifnot(names(tmb$fit$sample) == names(tmbstan$mcmc$sample))
```

# Pareto-smoothed importance sampling

Suppose we have two sets of samples from the posterior.
For each sample we are going to want to evaluate the log-likelihood, so that we can calculate the log-likelihood ratios.

Although we can extract a `TMB` objective function from `tmb` directly, it would correspond to the Laplace approximation.
As such we use a new objective function using `naomi_simple.cpp` directly:

```{r}
objfull <- readRDS("depends/objfull.rds")
objfull$fn(objfull$par)
```

The samples from `tmbstan` have the following values of `lp__`.
These should be equal to what would be obtained by putting the sample into `objfull$fn` (check this):

```{r}
tmbstan_samples <- rstan::extract(tmbstan$mcmc$stanfit)

data.frame(
  y = tmbstan_samples$lp__,
  x = 1:length(tmbstan_samples$lp__)
) %>%
  ggplot(aes(x = x, y = y)) +
    geom_point(alpha = 0.4) +
    labs(y = "Log-likelihood", x = "Draw number") +
    theme_minimal() 
```

Need to write a function which reformats `TMB` or `tmbstan` samples to be evaluated using `objfull$fn`:

```{r}
objfull$par

#' TODO
```
