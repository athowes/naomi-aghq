---
title: "Exceedance probability comparison for the simplified Naomi model"
author:
- name: Adam Howes
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    df_print: paged
    code_folding: show
    theme: lumen
bibliography: citations.bib
abstract: |
  **Background**  We have run the simplified Naomi model using a range of inference methods: `TMB`, `aghq`, `adam` and `tmbstan`.
  
  **Task** In this report, we compare the accuracy of the posterior distributions obtained from these inference methods using exceedance probabilities.
---

# Background

We compare the inference results from `TMB`, `aghq`, `adam`, and `tmbstan`.
Import these inference results as follows:

```{r}
tmb <- readRDS("depends/tmb.rds")
aghq <- readRDS("depends/aghq.rds")
tmbstan <- readRDS("depends/tmbstan.rds")
```

# Second 90

The 90-90-90 treatment targets are that

* 90% of PLHIV know their status
* 90% of PLHIV who kno wtheir status are on antiretroviral therapy (ART)
* 90% of PLHIV on ART have suppressed viral load

To meet the second 90, we require that $90\% \times 90\% = 81\%$ of PLHIV are on ART.

```{r}
mf_out <- tmb$naomi_data$mf_out

mf_out_fine <- mf_out %>%
  tibble::rownames_to_column("id") %>%
  mutate(id = as.numeric(id)) %>%
  filter(
    area_id %in% paste0("MWI_4_", 1:32, "_demo"),
    sex %in% c("male", "female"),
    age_group %in%
      c(
        "Y000_004", "Y005_009", "Y010_014", "Y015_019", "Y020_024", "Y025_029",
        "Y025_034", "Y030_034", "Y035_039", "Y040_044", "Y045_049", "Y050_054",
        "Y055_059", "Y060_064", "Y065_069", "Y070_074", "Y075_079", "Y080_999"
      )
  )

tmbstan_second90 <- apply(tmbstan$mcmc$sample$alpha_t1_out[mf_out_fine$id, ], 1, function(x) sum(x > 0.81) / length(x))
tmb_second90 <- apply(tmb$fit$sample$alpha_t1_out[mf_out_fine$id, ], 1, function(x) sum(x > 0.81) / length(x))
aghq_second90 <- apply(aghq$quad$sample$alpha_t1_out[mf_out_fine$id, ], 1, function(x) sum(x > 0.81) / length(x))
```

Plot the results from the different inference methods:

```{r}
n <- length(tmbstan_second90)
stopifnot(length(tmb_second90) == n)
stopifnot(length(aghq_second90) == n)

df_second90 <- data.frame(
  prob = c(tmbstan_second90, tmb_second90, aghq_second90),
  method = c(rep("tmbstan", times = n), rep("TMB", times = n), rep("aghq", times = n)),
  index = c(1:n, 1:n, 1:n)
)

df_wide_second90 <- pivot_wider(df_second90, names_from = method, values_from = prob)

plot1 <- ggplot(df_wide_second90, aes(x = tmbstan, y = TMB)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, col = "#CC79A7", linetype = "dashed") +
  labs(title = "Probability of 81% ART coverage in strata") +
  theme_minimal()

plot2 <- ggplot(df_wide_second90, aes(x = tmbstan, y = aghq)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, col = "#CC79A7", linetype = "dashed") +
  theme_minimal()

plot1 + plot2
```

Appears that: 1) systematic overestimation of probability by both approximate inference methods 2) `aghq` does better at not underestimating near zero.

What is the correlation?

```{r}
cor(tmbstan_second90, tmb_second90)
cor(tmbstan_second90, aghq_second90)
```

And what about the mean square error and root mean square error?

```{r}
(mse_tmb_second90 <- mean((tmbstan_second90 - tmb_second90)^2))
(mse_aghq_second90 <- mean((tmbstan_second90 - aghq_second90)^2))

(rmse_tmb_second90 <- sqrt(mse_tmb_second90))
(rmse_aghq_second90 <- sqrt(mse_aghq_second90))

mse_change <- round(100 * (mse_aghq_second90 - mse_tmb_second90) / mse_tmb_second90)
rmse_change <- round(100 * (rmse_aghq_second90 - rmse_tmb_second90) / rmse_tmb_second90)
```
There is a change of `r mse_change`% in the MSE moving from `TMB` to `aghq`, and a change of `r rmse_change`% in the RMSE.

Which strata have exceedance probabilities which are particularly poorly estimated?
First for `TMB`:

```{r}
tmb_fails_second90 <- df_wide_second90 %>%
  mutate(diff = tmbstan - TMB) %>%
  filter(diff > 0.1) %>%
  pull(index)
```
And for `aghq`:

```{r}
aghq_fails_second90 <- df_wide_second90 %>%
  mutate(diff = tmbstan - aghq) %>%
  filter(diff > 0.1) %>%
  pull(index)
```

There are `r sum(!(tmb_fails_second90 %in% aghq_fails_second90))` uniquely badly estimated by `TMB`, `r sum(!(aghq_fails_second90 %in% tmb_fails_second90))` uniquely badly estimated by `aghq`, and `r sum(tmb_fails_second90 %in% aghq_fails_second90)` badly estimated by both.
Which strata do these correspond to?

```{r}
unique(mf_out_fine[tmb_fails_second90, ]$area_id)
unique(mf_out_fine[tmb_fails_second90, ]$sex)
unique(mf_out_fine[tmb_fails_second90, ]$age_group)

unique(mf_out_fine[aghq_fails_second90, ]$area_id)
unique(mf_out_fine[aghq_fails_second90, ]$sex)
unique(mf_out_fine[aghq_fails_second90, ]$age_group)
```
Add colour by sex to the above plots:

```{r}
df_wide_second90 <- df_wide_second90 %>%
  left_join(
    mf_out_fine %>%
      tibble::rowid_to_column("index"),
    by = "index"
  )

write_csv(df_wide_second90, "second90.csv")

plot1 <- ggplot(df_wide_second90, aes(x = tmbstan, y = TMB, col = sex)) +
  geom_point(alpha = 0.3) +
  scale_color_manual(values = c("#56B4E9","#009E73")) +
  geom_abline(slope = 1, intercept = 0, col = "#CC79A7", linetype = "dashed") +
  labs(subtitle = "Probability of greater than 81% ART coverage in strata", col = "Sex") +
  guides(col = "none") +
  labs(x = "NUTS", y = "TMB") +
  theme_minimal()

plot2 <- ggplot(df_wide_second90, aes(x = tmbstan, y = aghq, col = sex)) +
  geom_point(alpha = 0.3) +
  scale_colour_manual(values = c("#56B4E9","#009E73"), labels = c("Female", "Male")) +
  geom_abline(slope = 1, intercept = 0, col = "#CC79A7", linetype = "dashed") +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  labs(x = "NUTS", y = "PCA-AGHQ", col = "Sex") +
  theme_minimal()

pdf("second90.pdf", h = 4, w = 6.25)

plot1 + plot2

dev.off()

plot1 + plot2
```
Check the RMSE stratified by sex:

```{r}
df_wide_second90 %>%
  group_by(sex) %>%
  summarise(
    "RMSE TMB (percent)" = 100 * sqrt(mean((tmbstan - TMB)^2)),
    "RMSE aghq (percent)" = 100 * sqrt(mean((tmbstan - aghq)^2))
  )
```

# High incidence strata

Above 1% incidence is considered high, and could be met with intensified interventions.

* Very high (>3%)
* High (1-3%)
* Moderate (0.3-1%)
* Low (<0.3%)

```{r}
tmbstan_1inc <- apply(tmbstan$mcmc$sample$lambda_t1_out[mf_out_fine$id, ], 1, function(x) sum(x > 0.01) / length(x))
tmb_1inc <- apply(tmb$fit$sample$lambda_t1_out[mf_out_fine$id, ], 1, function(x) sum(x > 0.01) / length(x))
aghq_1inc <- apply(aghq$quad$sample$lambda_t1_out[mf_out_fine$id, ], 1, function(x) sum(x > 0.01) / length(x))

n <- length(tmbstan_1inc)
stopifnot(length(tmb_1inc) == n)
stopifnot(length(aghq_1inc) == n)

df_1inc <- data.frame(
  prob = c(tmbstan_1inc, tmb_1inc, aghq_1inc),
  method = c(rep("tmbstan", times = n), rep("TMB", times = n), rep("aghq", times = n)),
  index = c(1:n, 1:n, 1:n)
)

df_wide_1inc <- pivot_wider(df_1inc, names_from = method, values_from = prob)

df_wide_1inc <- df_wide_1inc %>%
  left_join(
    mf_out_fine %>%
      tibble::rowid_to_column("index"),
    by = "index"
  )

write_csv(df_wide_1inc, "1inc.csv")

plot1 <- ggplot(df_wide_1inc, aes(x = tmbstan, y = TMB)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, col = "#CC79A7", linetype = "dashed") +
  labs(subtitle = "Probability of at least 1% incidence in strata") +
  theme_minimal()

plot2 <- ggplot(df_wide_1inc, aes(x = tmbstan, y = aghq)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, col = "#CC79A7", linetype = "dashed") +
  theme_minimal()

pdf("1inc.pdf", h = 4, w = 6.25)

plot1 + plot2

dev.off()

plot1 + plot2

cor(tmbstan_1inc, tmb_1inc)
cor(tmbstan_1inc, aghq_1inc)

mse_tmb_1inc <- mean((tmbstan_1inc - tmb_1inc)^2)
mse_aghq_1inc <- mean((tmbstan_1inc - aghq_1inc)^2)
round(100 * (mse_aghq_1inc - mse_tmb_1inc) / mse_tmb_1inc)

rmse_tmb_1inc <- sqrt(mse_tmb_1inc)
rmse_aghq_1inc <- sqrt(mse_aghq_1inc)
round(100 * (rmse_aghq_1inc - rmse_tmb_1inc) / rmse_tmb_1inc)
```

# Unmet treatment need

Number of people needing treatment is a function of ART coverage, HIV prevalence and population size.
What summaries of unmet treatment need might be important to calculate?

```{r}
#' To-do!
```

# Excursion and contour uncertainty regions

Based on @bolin2015excursion.

* $D_m = \{s: P(x(s) > u) \geq 1 - \alpha\}$ runs into the problem of multiple hypothesis testing
* Care about $P(x(s) > u, s \in D_m)$ which is smaller than $1 - \alpha$
* You can use the marginals and adjust the threshold to control type 1 error, false discovery rate, or posteior probabilites
* Bolin and Lindgren use sequential importance sampling to estimate the joint probabilities
* $x(s) > u$ is called a positive excursion set, and $x(s) < u$ is called a negative excursion set
* The `excursions` package can calculate excursion sets, contour credible regions and level avoiding sets, excursion functions, contour maps and their quality measures, and simultaneous confidence bands
